<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>note &#8212; Twitter Search APIs Python Wrapper 1.2.1 documentation</title>
    
    <link rel="stylesheet" href="_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.2.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-inverse navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html">
          Search Tweets APIs</a>
        <span class="navbar-text navbar-version pull-left"><b>1.2</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="https://github.com/twitterdev/search-tweets-python">Github</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="index.html">Search Tweets API <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="index.html">Python Twitter Search API</a></li>
<li class="toctree-l1"><a class="reference internal" href="searchtweets.html">searchtweets package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="searchtweets.html#submodules">Submodules</a></li>
<li class="toctree-l2"><a class="reference internal" href="searchtweets.html#module-searchtweets.api_utils">searchtweets.api_utils module</a></li>
<li class="toctree-l2"><a class="reference internal" href="searchtweets.html#module-searchtweets.result_stream">searchtweets.result_stream module</a></li>
<li class="toctree-l2"><a class="reference internal" href="searchtweets.html#module-searchtweets.utils">searchtweets.utils module</a></li>
<li class="toctree-l2"><a class="reference internal" href="searchtweets.html#module-searchtweets">Module contents</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#"><em>note</em></a></li>
<li><a class="reference internal" href="#working-with-twitter-data-examples-series">Working with Twitter Data Examples Series</a><ul>
<li><a class="reference internal" href="#data-collection-filtering-and-parsing">Data collection, filtering, and parsing</a><ul>
<li><a class="reference internal" href="#caveat">Caveat</a></li>
</ul>
</li>
<li><a class="reference internal" href="#using-twitter-data-to-answer-a-question">Using Twitter data to answer a question</a><ul>
<li><a class="reference internal" href="#why-do-we-want-to-know-this"><em>Why</em> do we want to know this?</a></li>
<li><a class="reference internal" href="#what-are-we-interested-in"><em>What</em> are we interested in?</a></li>
<li><a class="reference internal" href="#when-is-this-information-relevant"><em>When</em> is this information relevant?</a></li>
<li><a class="reference internal" href="#who-are-we-interested-in"><em>Who</em> are we interested in?</a></li>
<li><a class="reference internal" href="#where-are-they"><em>Where</em> are they?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#steps-to-get-to-an-answer">Steps to get to an answer:</a></li>
<li><a class="reference internal" href="#consume-tweet-data-the-twitter-search-api">1. Consume Tweet data: the Twitter Search API</a><ul>
<li><a class="reference internal" href="#twitter-api-query-language">Twitter API query language</a></li>
<li><a class="reference internal" href="#consuming-tweets">Consuming Tweets</a></li>
<li><a class="reference internal" href="#requesting-some-tweets">Requesting some Tweets</a></li>
<li><a class="reference internal" href="#getting-the-results">Getting the results</a></li>
<li><a class="reference internal" href="#python-client">Python client</a></li>
</ul>
</li>
<li><a class="reference internal" href="#parse-twitter-data">2. Parse Twitter data</a><ul>
<li><a class="reference internal" href="#the-nitty-gritty-tweet-payloads">The nitty gritty: Tweet payloads</a></li>
<li><a class="reference internal" href="#tweet-parser">tweet_parser</a></li>
<li><a class="reference internal" href="#before-you-read-these-tweets">Before you read these Tweets</a></li>
</ul>
</li>
<li><a class="reference internal" href="#describe-your-data">3. Describe your data</a><ul>
<li><a class="reference internal" href="#how-are-people-tweeting">How are people Tweeting?</a></li>
<li><a class="reference internal" href="#common-words">Common words</a></li>
<li><a class="reference internal" href="#tokenization">Tokenization</a></li>
<li><a class="reference internal" href="#counting">Counting</a></li>
<li><a class="reference internal" href="#hand-labeling">Hand labeling</a></li>
<li><a class="reference internal" href="#who-is-tweeting-who-is-speaking">Who is Tweeting? Who is speaking?</a></li>
<li><a class="reference internal" href="#time-series-plot">Time series plot</a></li>
<li><a class="reference internal" href="#counts-endpoint">Counts endpoint</a></li>
<li><a class="reference internal" href="#how-can-we-use-this-information-to-understand-our-search-data">How can we use this information to understand our search data?</a></li>
<li><a class="reference internal" href="#id1">Note:</a></li>
</ul>
</li>
<li><a class="reference internal" href="#iterate">3. Iterate</a><ul>
<li><a class="reference internal" href="#now-that-we-understand-what-we-re-matching-on">Now that we understand what we&#8217;re matching on</a></li>
<li><a class="reference internal" href="#look-at-that-regular-timeseries">Look at that regular timeseries!</a></li>
<li><a class="reference internal" href="#frequent-terms-vs-frequent-n-grams">Frequent terms vs frequent &#8220;n-grams&#8221;</a></li>
<li><a class="reference internal" href="#url-matching">URL matching</a></li>
<li><a class="reference internal" href="#look-how-much-irrelevant-data-we-ve-eliminated">Look how much irrelevant data we&#8217;ve eliminated</a></li>
<li><a class="reference internal" href="#pulling-our-dataset">Pulling our dataset</a></li>
<li><a class="reference internal" href="#store-the-data-you-pull">Store the data you pull!</a></li>
<li><a class="reference internal" href="#finalize-your-rule">Finalize your rule</a></li>
<li><a class="reference internal" href="#no-surprises">No surprises</a></li>
<li><a class="reference internal" href="#narrowing-your-dataset-further">Narrowing your dataset further</a></li>
<li><a class="reference internal" href="#save-tweets-to-a-file-and-stream-them-into-memory">Save Tweets to a file, and stream them into memory</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <div class="section" id="note">
<h1><em>note</em><a class="headerlink" href="#note" title="Permalink to this headline">Â¶</a></h1>
<p>This post is an early draft and we expect changes to be made to it, in
both code and content, before it is more broadly publicized. If you are
reading this and have any feedback for us regarding this post, please
reach out to either <a class="reference external" href="https://twitter.com/binary_aaron">&#64;binary_aaron</a>
or <a class="reference external" href="https://twitter.com/notFromShrek">&#64;notFromShrek</a> on Twitter or via
<a class="reference external" href="mailto:agonzales&#37;&#52;&#48;twitter&#46;com">email</a>.</p>
</div>
<div class="section" id="working-with-twitter-data-examples-series">
<h1>Working with Twitter Data Examples Series<a class="headerlink" href="#working-with-twitter-data-examples-series" title="Permalink to this headline">Â¶</a></h1>
<p>The Twitter Data Enterprise Solutions Data Science team wants to help
people get more out of Twitter data. We are going to publish a series of
focused examples that show how to work with various products in the
Twitter API ecosystem to help you get to answers more quickly.
Throughout our series, we will touch on many points on working with
Twitter data and how nuances of our data affect common data-processing
paradigms.</p>
<div class="section" id="data-collection-filtering-and-parsing">
<h2>Data collection, filtering, and parsing<a class="headerlink" href="#data-collection-filtering-and-parsing" title="Permalink to this headline">Â¶</a></h2>
<p>&#8211; By Fiona Pigott (&#64;notFromShrek), Twitter Data Scientist</p>
<p>In this inaugural post, I&#8217;ll introduce data collection, filtering,
parsing, and summarizing. I want to be able to give readers an easy way
to spin up on the Twitter Search API, some tips around quickly examining
data, and guidelines around one of the most difficult and most
overlooked Twitter data challenges: making sure you get the right Tweets
for the job.</p>
<div class="section" id="caveat">
<h3>Caveat<a class="headerlink" href="#caveat" title="Permalink to this headline">Â¶</a></h3>
<p>This post is not meant to be a tutorial in Python or the PyData
ecosystem and assumes that readers have a reasonable amount of technical
sophistication, such that they could find the right tweets for their use
case in any language or framework. Our group makes heavy use of the
PyData stack (python, pandas, numpy, etc.) and I suggest that you do to
for the ease of use in data science or analytics projects.</p>
</div>
</div>
<div class="section" id="using-twitter-data-to-answer-a-question">
<h2>Using Twitter data to answer a question<a class="headerlink" href="#using-twitter-data-to-answer-a-question" title="Permalink to this headline">Â¶</a></h2>
<p>Typically you will start with a very high-level question that requires
refinement to understand what data might be useful to you in answering
that question. For this post, let&#8217;s start with a broad question:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">I</span> <span class="n">want</span> <span class="n">to</span> <span class="n">understand</span> <span class="n">airline</span> <span class="n">customers</span> <span class="k">while</span> <span class="n">they</span> <span class="n">fly</span><span class="o">.</span>
</pre></div>
</div>
<p>We&#8217;ll begin our refinement process from here.</p>
<div class="section" id="why-do-we-want-to-know-this">
<h3><em>Why</em> do we want to know this?<a class="headerlink" href="#why-do-we-want-to-know-this" title="Permalink to this headline">Â¶</a></h3>
<p>Understanding the business need behind a question is paramount. Use it
to understand where it is important to spend extra time to be exact, and
where an estimation will suffice. Also use &#8220;why&#8221; to understand when the
analysis needs to be complete&#8211;the best analysis is not useful if it is
finished a month after a decision is made and presented.</p>
</div>
<div class="section" id="what-are-we-interested-in">
<h3><em>What</em> are we interested in?<a class="headerlink" href="#what-are-we-interested-in" title="Permalink to this headline">Â¶</a></h3>
<p>Use this question to help define where to begin with the analysis and
which data to pull. To understand airline customers&#8217; behavior while they
are flying and getting ready to fly, we are interested in people
actually in an airport or on a plane, but we are not interested in
people simple talking about airlines (sharing news stories about an
airline, for instance).</p>
</div>
<div class="section" id="when-is-this-information-relevant">
<h3><em>When</em> is this information relevant?<a class="headerlink" href="#when-is-this-information-relevant" title="Permalink to this headline">Â¶</a></h3>
<p>Deciding on a relevant timeframe is all about the business use case: if
you&#8217;re tracking a trend over a long period of time, you may need years
of data; if you&#8217;re looking at the audience of a single TV premier, a few
days of data may be enough.</p>
<p>In the case of my air travel question, I&#8217;m only interested in any given
Twitter user in the few hours around their plane flight, so I don&#8217;t
necessarily need to track Tweets over a long period of time. I do,
however, want to get enough of a sample to make generalizations about
how people Tweet before and after flights, so I should make sure I
collect enough data over a long enough period of time to examine
multiple flights.</p>
</div>
<div class="section" id="who-are-we-interested-in">
<h3><em>Who</em> are we interested in?<a class="headerlink" href="#who-are-we-interested-in" title="Permalink to this headline">Â¶</a></h3>
<p>Using simple rule filters like country and language can go a long way
towards helping us analyze Tweets from the right people. For more
detail, we can use available Twitter and partner tools to determine some
demographics about users&#8211;how old they are, their gender, their
nationality and language.</p>
<p>In this case, we&#8217;re interested in people from all demographics, as long
as they are <em>also</em> passengers on an airline. We can likely identify
those people through their language (&#8220;About to take off, headed home to
Boulder!&#8221;) or their granular geo-tagged location or Twitter place
(&#8220;Denver International Airport&#8221;).</p>
</div>
<div class="section" id="where-are-they">
<h3><em>Where</em> are they?<a class="headerlink" href="#where-are-they" title="Permalink to this headline">Â¶</a></h3>
<p>We can use Twitter&#8217;s geo data and enrichments to make sure that our
users are in relevant locations, if that is important to the question.
Another way to approximate a user&#8217;s location might be the language they
speak, or even the time that they are Tweeting (if you&#8217;re collecting
Tweets at 2AM PST, don&#8217;t expect to see a lot of content from
California).</p>
<p>Remember, selecting only users for whom we have a very granular
locations (like a geo-tag near an airport) means that we only get a
sample of users. For studies where we want to know generally what people
are talking about that might not be a problem, but it isn&#8217;t as effective
for studies where we want an exact count. Keep those trade-offs in mind
when designing a data query.</p>
</div>
</div>
<hr class="docutils" />
<div class="section" id="steps-to-get-to-an-answer">
<h2>Steps to get to an answer:<a class="headerlink" href="#steps-to-get-to-an-answer" title="Permalink to this headline">Â¶</a></h2>
<ol class="arabic simple">
<li>Consume Tweet data<ul>
<li>We need to get Tweets to analyze them. I&#8217;ll walk through using the
Python client for the Twitter Search API right inside this
notebook. All you need is an account.</li>
</ul>
</li>
<li>Parse Twitter data<ul>
<li>You can&#8217;t analyze what you can&#8217;t load. Understand the structure of
the data, and get the pieces that are important to your analysis.</li>
</ul>
</li>
<li>Describe Twitter data<ul>
<li>Descriptive statistics go a long way. What are the most popular
hashtags? When are people Tweeting about these topics? Where is
noise coming from? Are there specific URLs, hashtags, or
&#64;-mentions being shared that <em>aren&#8217;t</em> relevant to your analysis?</li>
</ul>
</li>
<li>Iterate on your search terms to filter the data<ul>
<li>We can&#8217;t simply ask for every Tweet. A thoughtful analysis needs
to work within the bounds of the Twitter data APIs to filter and
retrieve the right data for the job&#8211;and for your data budget. Now
that you know how to quickly edit rules to retrieve small
quantities of data, as well as parse and describe a set of Tweets,
it&#8217;s time to iterate on filters to retrieve the data that is
relevant to your question (and not pay for data that isn&#8217;t).</li>
</ul>
</li>
</ol>
</div>
<hr class="docutils" />
<div class="section" id="consume-tweet-data-the-twitter-search-api">
<h2>1. Consume Tweet data: the Twitter Search API<a class="headerlink" href="#consume-tweet-data-the-twitter-search-api" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="twitter-api-query-language">
<h3>Twitter API query language<a class="headerlink" href="#twitter-api-query-language" title="Permalink to this headline">Â¶</a></h3>
<p>In order to pull Tweets from the Search API, you will first have to
understand how to write a search query in Twitter&#8217;s Premium / Enterprise
Search API query language. The most important basics are these:</p>
<ul class="simple">
<li>Token matches: A simple token match occurs within the text of the
Tweet (includes the links that appear in that text, but, for
instance, this would not include the text of the Tweet author&#8217;s
name). Token matches always disregard case.</li>
<li>AND: words (tokens) joined by a space are treated as queries and-ed
together. For instance, the query &#8220;<code class="docutils literal"><span class="pre">cat</span> <span class="pre">dog</span></code>&#8221; would search for
Tweets with both <code class="docutils literal"><span class="pre">cat</span></code> and <code class="docutils literal"><span class="pre">dog</span></code> somewhere in the text of the
Tweet.</li>
<li>OR: the operator &#8220;<code class="docutils literal"><span class="pre">OR</span></code>&#8221; (capitalization is important here) between
two tokens means that your rule will match on either term (without
needing both to be present). The rule &#8220;<code class="docutils literal"><span class="pre">cat</span> <span class="pre">OR</span> <span class="pre">dog</span></code>&#8221; will match on
a Tweet with <em>either</em> &#8220;<code class="docutils literal"><span class="pre">cat</span></code>&#8221; or &#8220;<code class="docutils literal"><span class="pre">dog</span></code>&#8221; in the Tweet text.</li>
<li>Grouping: use parentheses <code class="docutils literal"><span class="pre">()</span></code> to group tokens together. In the
query-language order of operations, <code class="docutils literal"><span class="pre">AND</span></code> is applied before <code class="docutils literal"><span class="pre">OR</span></code>,
so use parenthese to make your groups explicit.
&#8220;<code class="docutils literal"><span class="pre">cat</span> <span class="pre">dog</span> <span class="pre">OR</span> <span class="pre">bunny</span></code>&#8221; is different from &#8220;<code class="docutils literal"><span class="pre">cat</span> <span class="pre">(dog</span> <span class="pre">OR</span> <span class="pre">bunny)</span></code>&#8221;
(can you see why?).</li>
<li>Negation: use the operator &#8220;<code class="docutils literal"><span class="pre">-</span></code>&#8221; to negate terms. You might search
for Tweets about cats and <em>not</em> about dogs with this type of query
&#8220;<code class="docutils literal"><span class="pre">cat</span> <span class="pre">-dog</span></code>&#8221;.</li>
</ul>
<p>Detailed information on operators can be found
<a class="reference external" href="https://developer.twitter.com/en/docs/tweets/search/guides/premium-operators">here</a>.
I&#8217;ll use and introduce some more advanced operators later.</p>
</div>
<div class="section" id="consuming-tweets">
<h3>Consuming Tweets<a class="headerlink" href="#consuming-tweets" title="Permalink to this headline">Â¶</a></h3>
<p>In order to Search for Tweets, we&#8217;re going to use Twitter&#8217;s fully
supported, <a class="reference external" href="https://developer.twitter.com/en/docs/tweets/search/overview/full-archive-search">enterprise-grade Twitter search
tool</a>.
This tools allows a user to make a request for Tweets by specifying a
rule (more on that in a minute) that matches some Tweets and retrieve
results. This tutorial is also compatible with the 30-day search API,
though you will have to change some of the dates for searching due to
the 30-day historic limitation.</p>
</div>
<div class="section" id="requesting-some-tweets">
<h3>Requesting some Tweets<a class="headerlink" href="#requesting-some-tweets" title="Permalink to this headline">Â¶</a></h3>
<p>In order to search for Tweets, we have to understand specifically how
Twitter&#8217;s search rules work. I&#8217;ll outline a few simple rules, and we&#8217;ll
talk more about details later when we iterate on our rules.</p>
<div class="line-block">
<div class="line"><strong>Time window for search</strong></div>
<div class="line">Look for Tweets within a certain time window by specifying the time
window in minute granularity.</div>
</div>
<div class="line-block">
<div class="line"><strong>Search rules are simple, boolean, token matches</strong></div>
<div class="line">Tweets are tokenized on spaces and punctuation, and those tokens are
matched to a rule. Let&#8217;s look at a simple example:</div>
<div class="line">&gt; <strong>Tweet</strong>:
<code class="docutils literal"><span class="pre">&quot;Boarding</span> <span class="pre">the</span> <span class="pre">plane</span> <span class="pre">to</span> <span class="pre">fly</span> <span class="pre">to</span> <span class="pre">Tokyo</span> <span class="pre">in</span> <span class="pre">a</span> <span class="pre">few</span> <span class="pre">hours!</span> <span class="pre">So</span> <span class="pre">excited!&quot;</span></code></div>
<div class="line">&gt; <strong>Tokens</strong> (capitalization is ignored):
<code class="docutils literal"><span class="pre">&quot;boarding&quot;,</span> <span class="pre">&quot;the&quot;,</span> <span class="pre">&quot;plane&quot;,</span> <span class="pre">&quot;to&quot;,</span> <span class="pre">&quot;fly&quot;,</span> <span class="pre">&quot;to&quot;,</span> <span class="pre">&quot;tokyo&quot;,</span> <span class="pre">&quot;in&quot;,</span> <span class="pre">&quot;a&quot;,</span> <span class="pre">&quot;few&quot;,</span> <span class="pre">&quot;hours&quot;,</span> <span class="pre">&quot;so,</span> <span class="pre">&quot;excited&quot;</span></code></div>
</div>
<p>A rule that collected this Tweet might have been <code class="docutils literal"><span class="pre">&quot;plane&quot;</span></code> (because
the exact token <code class="docutils literal"><span class="pre">&quot;plane&quot;</span></code> is included in the token list). You should
note that these matches rely on complete tokens: this Tweet would
<strong>not</strong> match if our rule was <code class="docutils literal"><span class="pre">&quot;airplane&quot;</span></code>.</p>
<div class="line-block">
<div class="line"><strong>You can search for more than one token in a rule</strong></div>
<div class="line">A search for Tweets about flying on planes might include any Tweet
with the word <code class="docutils literal"><span class="pre">&quot;airplane&quot;</span></code> <em>or</em> the word <code class="docutils literal"><span class="pre">&quot;plane&quot;</span></code> <em>or</em> the word
<code class="docutils literal"><span class="pre">&quot;flying&quot;</span></code> to get all of the relevant Tweets. In a single rule, use
the operator <code class="docutils literal"><span class="pre">OR</span></code> (capitalization is important here) to search for
<em>any</em> of a set of keywords.</div>
<div class="line">&gt; <code class="docutils literal"><span class="pre">&quot;airplane</span> <span class="pre">OR</span> <span class="pre">plane</span> <span class="pre">OR</span> <span class="pre">flying&quot;</span></code></div>
</div>
<div class="line-block">
<div class="line"><strong>You can combine criteria using *and* logic, and combine tokens into
phrases using quotation marks</strong></div>
<div class="line">Maybe you want the to find Tweet that include the word <code class="docutils literal"><span class="pre">&quot;flying&quot;</span></code>
and the word <code class="docutils literal"><span class="pre">&quot;plane&quot;</span></code> but only when they appear together. Here, you
would want to use Boolean <code class="docutils literal"><span class="pre">AND</span></code> logic to combine tokens into a
single rule. In the syntax of Twitter&#8217;s Search API, <code class="docutils literal"><span class="pre">AND</span></code> is simply
represented by a space. &gt; <strong>rule</strong>: <code class="docutils literal"><span class="pre">flying</span> <span class="pre">plane</span></code></div>
<div class="line">&gt; <strong>match</strong>: <code class="docutils literal"><span class="pre">&quot;I'm</span> <span class="pre">flying</span> <span class="pre">in</span> <span class="pre">a</span> <span class="pre">plane!&quot;</span></code></div>
<div class="line">&gt; <strong>no match</strong>: <code class="docutils literal"><span class="pre">&quot;I'm</span> <span class="pre">flying!&quot;</span></code> or <code class="docutils literal"><span class="pre">&quot;I'm</span> <span class="pre">in</span> <span class="pre">a</span> <span class="pre">plane!&quot;</span></code></div>
</div>
<div class="line-block">
<div class="line">You can also look for specific phrases (combinations of tokens) using
quotation marks. Use <code class="docutils literal"><span class="pre">&quot;</span></code> to combine tokens and look for them in a
specific phrase. &gt; <strong>rule</strong>: <code class="docutils literal"><span class="pre">&quot;air</span> <span class="pre">travel&quot;</span></code></div>
<div class="line">&gt; <strong>match</strong>: <code class="docutils literal"><span class="pre">&quot;Air</span> <span class="pre">travel</span> <span class="pre">is</span> <span class="pre">great&quot;</span></code></div>
<div class="line">&gt; <strong>no match</strong>: <code class="docutils literal"><span class="pre">&quot;Travel</span> <span class="pre">by</span> <span class="pre">air</span> <span class="pre">is</span> <span class="pre">great&quot;</span></code> or
<code class="docutils literal"><span class="pre">&quot;Traveling</span> <span class="pre">in</span> <span class="pre">an</span> <span class="pre">airplane&quot;</span></code></div>
</div>
<div class="line-block">
<div class="line"><strong>You can exclude certain tokens that are irrelevant to your
analysis</strong></div>
<div class="line">Keep in mind that tokens do not exactly map to meaning (especially on
a colloquial platform like Twitter). If you are looking for Tweets
about flying (on an airplane), and you submit the rule <code class="docutils literal"><span class="pre">&quot;flying&quot;</span></code>,
<code class="docutils literal"><span class="pre">&quot;I</span> <span class="pre">don't</span> <span class="pre">give</span> <span class="pre">a</span> <span class="pre">flying</span> <span class="pre">f**k</span> <span class="pre">what</span> <span class="pre">you</span> <span class="pre">do.&quot;</span></code> would match your rule
(true story: I&#8217;ve had to exclude the phrase <code class="docutils literal"><span class="pre">&quot;flying</span> <span class="pre">f**k&quot;</span></code> from
this analysis ðŸ˜³).</div>
<div class="line">Use a &#8220;<code class="docutils literal"><span class="pre">-</span></code>&#8221; to exclude, and use parentheses to group together
logical clauses: &gt; <code class="docutils literal"><span class="pre">&quot;(airplane</span> <span class="pre">OR</span> <span class="pre">plane</span> <span class="pre">OR</span> <span class="pre">flying)</span> <span class="pre">-fuck&quot;</span></code></div>
</div>
<p>This isn&#8217;t a comprehensive guide, and more clarification can be found in
our
<a class="reference external" href="http://support.gnip.com/apis/search_api2.0/rules.html">documentation</a>.</p>
</div>
<div class="section" id="getting-the-results">
<h3>Getting the results<a class="headerlink" href="#getting-the-results" title="Permalink to this headline">Â¶</a></h3>
<p>Twitter&#8217;s Search API returns results in <em>pages</em>, with up to 500 Tweets
per page for paid tiers. For users in a sandbox environment, you can
receive a maximum of 100 Tweets per call. For a very low-volume search,
you might only need one page to retrieve all of the results. For a
high-volume search, you can choose to make multiple API call to receive
multiple pages of results.</p>
</div>
<div class="section" id="python-client">
<h3>Python client<a class="headerlink" href="#python-client" title="Permalink to this headline">Â¶</a></h3>
<p>Consuming data from Twitter APIs directly into an environment where we
can analyze them is important for fast iteration on queries. The data
science team has created some Python libraries that make it easy to
consume data from Twitter&#8217;s Search API product directly into this
notebook.</p>
<p>This package can be found at
<a class="reference external" href="https://github.com/tw-ddis/twitter_search_api/">https://github.com/tw-ddis/twitter_search_api/</a> and implements a Python
wrapper to: - Create appropriately formatted rule payloads (date and
rule query parameters) - Make requests of the API - Gracefully handle
pagination of Search API results (be aware&#8211;the tool can make multiple
API calls, so but sure to set the <code class="docutils literal"><span class="pre">max_tweets</span></code> parameter, which I&#8217;ll
point out) - Load the resultant Tweet text data as Python objects</p>
<p>Please go ahead and make a YAML file in your home directory that looks
like this:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">twitter_search_api</span><span class="p">:</span>
  <span class="n">endpoint</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">FULL_URL_OF_ENDPOINT</span><span class="o">&gt;</span>
  <span class="n">account</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">ACCOUNT_NAME</span><span class="o">&gt;</span>
  <span class="n">username</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">USERNAME</span><span class="o">&gt;</span>
  <span class="n">password</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">PW</span><span class="o">&gt;</span>
  <span class="n">bearer_token</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">TOKEN</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The rest of the example will assume you have put this in a file called
<code class="docutils literal"><span class="pre">~/.twitter_keys.yaml</span></code>, though you can specify your connection
information directing in the notebook or using an environemnt variable
if you want.</p>
<p>If you are a premium user (or testing out premium), please set
<code class="docutils literal"><span class="pre">bearer_token</span></code>. If you have an enterprise account, please set your
account name and password. In the following cell, be sure to only
specify the relevant fields for your access method.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Twitter data API libraries developed by the data science team to spin you up faster on Twitter data</span>
<span class="kn">from</span> <span class="nn">tweet_parser.tweet</span> <span class="k">import</span> <span class="n">Tweet</span>
<span class="kn">from</span> <span class="nn">twittersearch.result_stream</span> <span class="k">import</span> <span class="n">ResultStream</span><span class="p">,</span> <span class="n">collect_results</span>
<span class="kn">from</span> <span class="nn">twittersearch</span> <span class="k">import</span> <span class="n">gen_rule_payload</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">yaml</span>

<span class="c1"># your account and password for enterprise access</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~/.twitter_keys.yaml&quot;</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">creds</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="n">search_args</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">creds</span><span class="p">[</span><span class="s2">&quot;twitter_search_api&quot;</span><span class="p">][</span><span class="s2">&quot;username&quot;</span><span class="p">],</span>
               <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="n">creds</span><span class="p">[</span><span class="s2">&quot;twitter_search_api&quot;</span><span class="p">][</span><span class="s2">&quot;password&quot;</span><span class="p">],</span>
               <span class="s2">&quot;endpoint&quot;</span><span class="p">:</span> <span class="n">creds</span><span class="p">[</span><span class="s2">&quot;twitter_search_api&quot;</span><span class="p">][</span><span class="s2">&quot;endpoint&quot;</span><span class="p">]}</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># start with a very simple rule</span>
<span class="n">_rule_a</span> <span class="o">=</span> <span class="s2">&quot;(flying OR plane OR landed OR airport OR takeoff)&quot;</span>

<span class="n">rule_a</span> <span class="o">=</span> <span class="n">gen_rule_payload</span><span class="p">(</span><span class="n">_rule_a</span><span class="p">,</span>
                        <span class="n">from_date</span><span class="o">=</span><span class="s2">&quot;2017-07-01&quot;</span><span class="p">,</span>
                        <span class="n">to_date</span><span class="o">=</span><span class="s2">&quot;2017-08-01&quot;</span><span class="p">,</span>
                        <span class="n">results_per_call</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span> <span class="c1"># the max_results parameter sets</span>
                                         <span class="c1"># the number of Tweets I receive per API call.</span>
                                         <span class="c1"># this value can be at most 500</span>

<span class="c1"># results</span>
<span class="c1"># note: &quot;collect_results&quot; is a function that collects all of the results of (potentially many) API calls and</span>
<span class="c1">#       stores them as a list. later, I&#39;ll use a ResultStream object to show you how to stream Tweets as an iterator</span>
<span class="c1">#       (potentially avoid memory issues and speeding up working with very large quantities of Tweets).</span>
<span class="n">results_list</span> <span class="o">=</span> <span class="n">collect_results</span><span class="p">(</span><span class="n">rule_a</span><span class="p">,</span>
                               <span class="n">max_results</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span> <span class="c1"># this is the maximum number of Tweets you want to receive</span>
                                                  <span class="c1"># the number of API calls that you make will be roughly:</span>
                                                  <span class="c1">#  = max_tweets / max_results</span>
                               <span class="n">result_stream_args</span><span class="o">=</span><span class="n">search_args</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># hark, a Tweet!</span>
<span class="n">results_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s1">&#39;contributors&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
 <span class="s1">&#39;coordinates&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
 <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="s1">&#39;Mon Jul 31 23:59:59 +0000 2017&#39;</span><span class="p">,</span>
 <span class="s1">&#39;entities&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;hashtags&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;indices&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">43</span><span class="p">,</span> <span class="mi">50</span><span class="p">],</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;defcon&#39;</span><span class="p">}],</span>
  <span class="s1">&#39;symbols&#39;</span><span class="p">:</span> <span class="p">[],</span>
  <span class="s1">&#39;urls&#39;</span><span class="p">:</span> <span class="p">[],</span>
  <span class="s1">&#39;user_mentions&#39;</span><span class="p">:</span> <span class="p">[]},</span>
 <span class="s1">&#39;favorite_count&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
 <span class="s1">&#39;favorited&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
 <span class="s1">&#39;filter_level&#39;</span><span class="p">:</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span>
 <span class="s1">&#39;geo&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
 <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">892173026116202498</span><span class="p">,</span>
 <span class="s1">&#39;id_str&#39;</span><span class="p">:</span> <span class="s1">&#39;892173026116202498&#39;</span><span class="p">,</span>
 <span class="s1">&#39;in_reply_to_screen_name&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
 <span class="s1">&#39;in_reply_to_status_id&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
 <span class="s1">&#39;in_reply_to_status_id_str&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
 <span class="s1">&#39;in_reply_to_user_id&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
 <span class="s1">&#39;in_reply_to_user_id_str&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
 <span class="s1">&#39;is_quote_status&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
 <span class="s1">&#39;lang&#39;</span><span class="p">:</span> <span class="s1">&#39;en&#39;</span><span class="p">,</span>
 <span class="s1">&#39;matching_rules&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}],</span>
 <span class="s1">&#39;place&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
 <span class="s1">&#39;quote_count&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
 <span class="s1">&#39;reply_count&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
 <span class="s1">&#39;retweet_count&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
 <span class="s1">&#39;retweeted&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
 <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;a href=&quot;http://tapbots.com/tweetbot&quot; rel=&quot;nofollow&quot;&gt;Tweetbot for iÎŸS&lt;/a&gt;&#39;</span><span class="p">,</span>
 <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;Left for airport at 4:45AM, pleased to see #defcon hackers still partying at Caesars bars. Not pleased to be heading to airport at 4:45AM.&#39;</span><span class="p">,</span>
 <span class="s1">&#39;truncated&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
 <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;contributors_enabled&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
  <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="s1">&#39;Tue Jul 26 12:59:48 +0000 2016&#39;</span><span class="p">,</span>
  <span class="s1">&#39;default_profile&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
  <span class="s1">&#39;default_profile_image&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
  <span class="s1">&#39;derived&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;klout&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;influence_topics&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;14711&#39;</span><span class="p">,</span>
      <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Computers&#39;</span><span class="p">,</span>
      <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mf">0.6900000000000001</span><span class="p">,</span>
      <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="s1">&#39;http://klout.com/topic/id/14711&#39;</span><span class="p">},</span>
     <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;10000000000000000013&#39;</span><span class="p">,</span>
      <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Armed Forces&#39;</span><span class="p">,</span>
      <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mf">0.54</span><span class="p">,</span>
      <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="s1">&#39;http://klout.com/topic/id/10000000000000000013&#39;</span><span class="p">},</span>
     <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;5715144008489027056&#39;</span><span class="p">,</span>
      <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Hacking&#39;</span><span class="p">,</span>
      <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mf">0.54</span><span class="p">,</span>
      <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="s1">&#39;http://klout.com/topic/id/5715144008489027056&#39;</span><span class="p">},</span>
     <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;6333513374221291742&#39;</span><span class="p">,</span>
      <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Information Security&#39;</span><span class="p">,</span>
      <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mf">0.44</span><span class="p">,</span>
      <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="s1">&#39;http://klout.com/topic/id/6333513374221291742&#39;</span><span class="p">},</span>
     <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;8339859935962972745&#39;</span><span class="p">,</span>
      <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Malware&#39;</span><span class="p">,</span>
      <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span>
      <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="s1">&#39;http://klout.com/topic/id/8339859935962972745&#39;</span><span class="p">}],</span>
    <span class="s1">&#39;interest_topics&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;6333513374221291742&#39;</span><span class="p">,</span>
      <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Information Security&#39;</span><span class="p">,</span>
      <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mf">0.7000000000000001</span><span class="p">,</span>
      <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="s1">&#39;http://klout.com/topic/id/6333513374221291742&#39;</span><span class="p">},</span>
     <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;8339859935962972745&#39;</span><span class="p">,</span>
      <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Malware&#39;</span><span class="p">,</span>
      <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mf">0.68</span><span class="p">,</span>
      <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="s1">&#39;http://klout.com/topic/id/8339859935962972745&#39;</span><span class="p">},</span>
     <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;10000000000000000013&#39;</span><span class="p">,</span>
      <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Armed Forces&#39;</span><span class="p">,</span>
      <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mf">0.67</span><span class="p">,</span>
      <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="s1">&#39;http://klout.com/topic/id/10000000000000000013&#39;</span><span class="p">},</span>
     <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;5715144008489027056&#39;</span><span class="p">,</span>
      <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Hacking&#39;</span><span class="p">,</span>
      <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mf">0.67</span><span class="p">,</span>
      <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="s1">&#39;http://klout.com/topic/id/5715144008489027056&#39;</span><span class="p">},</span>
     <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;14711&#39;</span><span class="p">,</span>
      <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Computers&#39;</span><span class="p">,</span>
      <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mf">0.62</span><span class="p">,</span>
      <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="s1">&#39;http://klout.com/topic/id/14711&#39;</span><span class="p">}],</span>
    <span class="s1">&#39;profile_url&#39;</span><span class="p">:</span> <span class="s1">&#39;http://klout.com/user/id/120189854649800254&#39;</span><span class="p">,</span>
    <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
    <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="s1">&#39;120189854649800254&#39;</span><span class="p">}},</span>
  <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;davrik&#39;</span><span class="p">,</span>
  <span class="s1">&#39;favourites_count&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s1">&#39;follow_request_sent&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
  <span class="s1">&#39;followers_count&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
  <span class="s1">&#39;following&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
  <span class="s1">&#39;friends_count&#39;</span><span class="p">:</span> <span class="mi">27</span><span class="p">,</span>
  <span class="s1">&#39;geo_enabled&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
  <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">757923373951422464</span><span class="p">,</span>
  <span class="s1">&#39;id_str&#39;</span><span class="p">:</span> <span class="s1">&#39;757923373951422464&#39;</span><span class="p">,</span>
  <span class="s1">&#39;is_translator&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
  <span class="s1">&#39;lang&#39;</span><span class="p">:</span> <span class="s1">&#39;en&#39;</span><span class="p">,</span>
  <span class="s1">&#39;listed_count&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="s1">&#39;cyber cyber cyber&#39;</span><span class="p">,</span>
  <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;davrik&#39;</span><span class="p">,</span>
  <span class="s1">&#39;notifications&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
  <span class="s1">&#39;profile_background_color&#39;</span><span class="p">:</span> <span class="s1">&#39;F5F8FA&#39;</span><span class="p">,</span>
  <span class="s1">&#39;profile_background_image_url&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
  <span class="s1">&#39;profile_background_image_url_https&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
  <span class="s1">&#39;profile_background_tile&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
  <span class="s1">&#39;profile_banner_url&#39;</span><span class="p">:</span> <span class="s1">&#39;https://pbs.twimg.com/profile_banners/757923373951422464/1469539141&#39;</span><span class="p">,</span>
  <span class="s1">&#39;profile_image_url&#39;</span><span class="p">:</span> <span class="s1">&#39;http://pbs.twimg.com/profile_images/757928014541905920/raYPrm1a_normal.jpg&#39;</span><span class="p">,</span>
  <span class="s1">&#39;profile_image_url_https&#39;</span><span class="p">:</span> <span class="s1">&#39;https://pbs.twimg.com/profile_images/757928014541905920/raYPrm1a_normal.jpg&#39;</span><span class="p">,</span>
  <span class="s1">&#39;profile_link_color&#39;</span><span class="p">:</span> <span class="s1">&#39;1DA1F2&#39;</span><span class="p">,</span>
  <span class="s1">&#39;profile_sidebar_border_color&#39;</span><span class="p">:</span> <span class="s1">&#39;C0DEED&#39;</span><span class="p">,</span>
  <span class="s1">&#39;profile_sidebar_fill_color&#39;</span><span class="p">:</span> <span class="s1">&#39;DDEEF6&#39;</span><span class="p">,</span>
  <span class="s1">&#39;profile_text_color&#39;</span><span class="p">:</span> <span class="s1">&#39;333333&#39;</span><span class="p">,</span>
  <span class="s1">&#39;profile_use_background_image&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
  <span class="s1">&#39;protected&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
  <span class="s1">&#39;screen_name&#39;</span><span class="p">:</span> <span class="s1">&#39;0davrik&#39;</span><span class="p">,</span>
  <span class="s1">&#39;statuses_count&#39;</span><span class="p">:</span> <span class="mi">17</span><span class="p">,</span>
  <span class="s1">&#39;time_zone&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
  <span class="s1">&#39;translator_type&#39;</span><span class="p">:</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span>
  <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
  <span class="s1">&#39;utc_offset&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
  <span class="s1">&#39;verified&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="parse-twitter-data">
<h2>2. Parse Twitter data<a class="headerlink" href="#parse-twitter-data" title="Permalink to this headline">Â¶</a></h2>
<p>Let&#8217;s take the 1st Tweet from our results list and discuss its various
elements.</p>
<p>Tweet data is returned from the API as JSON payloads: 1 JSON formatted
payload per Tweet, 1 Tweet per line (separated by <code class="docutils literal"><span class="pre">\n</span></code>). The
<code class="docutils literal"><span class="pre">twittersearch</span></code> package parses that data for you using our
<code class="docutils literal"><span class="pre">tweet_parser</span></code> (<a class="reference external" href="https://github.com/tw-ddis/tweet_parser">https://github.com/tw-ddis/tweet_parser</a>) package and
handles any errors caused by non-Tweet messages (like logging messages),
returning <code class="docutils literal"><span class="pre">Tweet</span></code> objects (I&#8217;ll explain about that in a second).</p>
<p>To better understand Tweets, you should check out
<a class="reference external" href="http://support.gnip.com/sources/twitter/data_format.html">support.gnip.com</a>
for information on Tweet payload elements. For now, I&#8217;m going to explain
a few key elements of a Tweet and how to access them.</p>
<div class="section" id="the-nitty-gritty-tweet-payloads">
<h3>The nitty gritty: Tweet payloads<a class="headerlink" href="#the-nitty-gritty-tweet-payloads" title="Permalink to this headline">Â¶</a></h3>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># grab a single example Tweet: just the first one from our list</span>
<span class="c1"># this is a Tweet object, but if we print it out, it looks like a python dictionary</span>
<span class="c1"># that&#39;s because a Tweet object is just a Python dictionary with a few special properties defined</span>
<span class="n">example_tweet</span> <span class="o">=</span> <span class="n">results_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">example_tweet</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mi">892173026116202498</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><strong>A note on Tweet formatting and payload element naming</strong></div>
<div class="line">I happen to know that the format of this Tweet is &#8220;original format,&#8221;
so I can look up the keys (names of payload elements) on our support
website. It&#8217;s possible (but unlikely) that your Search API stream is
configured slightly differently, and you&#8217;re looking at &#8220;activity
streams&#8221; formatted Tweets (this is completely fine). I&#8217;ll add the
equivalent &#8220;activity streams&#8221; keys in the comments.</div>
</div>
<p><strong>Now, the text of a Tweet:</strong></p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># the text of the Tweet (the thing you type, the characters that display in the Tweet)</span>
<span class="c1"># is stored as a top-level key called &quot;text&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;text&quot;</span><span class="p">])</span>

<span class="c1"># uncomment the following if you appear to have an activity-stream formatted Tweet</span>
<span class="c1"># (the names of the payload elements are different, the data is similar):</span>
<span class="c1">#results_list[0][&quot;body&quot;]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Left</span> <span class="k">for</span> <span class="n">airport</span> <span class="n">at</span> <span class="mi">4</span><span class="p">:</span><span class="mi">45</span><span class="n">AM</span><span class="p">,</span> <span class="n">pleased</span> <span class="n">to</span> <span class="n">see</span> <span class="c1">#defcon hackers still partying at Caesars bars. Not pleased to be heading to airport at 4:45AM.</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><strong>Other Tweet elements</strong></div>
<div class="line">Be sure to read the documentation, as I&#8217;m not going to enumerate every
Tweet element here. I will note that certain fundamental and useful
Tweet elements are extracted for you, such as a #hashtag or an
&#64;mention.</div>
</div>
<p>You can access, for instance, a Tweet&#8217;s #hashtags like this:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">results_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;entities&quot;</span><span class="p">][</span><span class="s2">&quot;hashtags&quot;</span><span class="p">]</span>

<span class="c1"># uncomment the following if you appear to have an activity-stream formatted Tweet</span>
<span class="c1">#results_list[0][&quot;twitter_entities&quot;][&quot;hashtags&quot;]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[{</span><span class="s1">&#39;indices&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">43</span><span class="p">,</span> <span class="mi">50</span><span class="p">],</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;defcon&#39;</span><span class="p">}]</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># in case that first Tweet didn&#39;t actually have any hashtags:</span>
<span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;entities&quot;</span><span class="p">][</span><span class="s2">&quot;hashtags&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results_list</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]]</span>

<span class="c1"># uncomment the following if you appear to have an activity-stream formatted Tweet</span>
<span class="c1">#[x[&quot;twitter_entities&quot;][&quot;hashtags&quot;] for x in results_list[0:10]]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[[{</span><span class="s1">&#39;indices&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">43</span><span class="p">,</span> <span class="mi">50</span><span class="p">],</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;defcon&#39;</span><span class="p">}],</span>
 <span class="p">[],</span>
 <span class="p">[{</span><span class="s1">&#39;indices&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">22</span><span class="p">,</span> <span class="mi">30</span><span class="p">],</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;Algerie&#39;</span><span class="p">}],</span>
 <span class="p">[],</span>
 <span class="p">[],</span>
 <span class="p">[{</span><span class="s1">&#39;indices&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;New&#39;</span><span class="p">}],</span>
 <span class="p">[],</span>
 <span class="p">[],</span>
 <span class="p">[],</span>
 <span class="p">[]]</span>
</pre></div>
</div>
</div>
<div class="section" id="tweet-parser">
<h3>tweet_parser<a class="headerlink" href="#tweet-parser" title="Permalink to this headline">Â¶</a></h3>
<p>You will always need to understand Tweet payloads to work with Tweets,
but a Python package from this team (<code class="docutils literal"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">tweet_parser</span></code>)
attempts to remove some of the hassle of accessing elements of a Tweet.
This package works seamlessly with both possible Twitter data formats,
and supplies the <code class="docutils literal"><span class="pre">Tweet</span></code> object I referred to earlier.</p>
<p>Before doing a lot of work with this package (but not right this
minute!), I would encourage you to read the documentation for the
<code class="docutils literal"><span class="pre">tweet_parser</span></code> package at <a class="reference external" href="https://twitterdev.github.io/tweet_parser/">https://twitterdev.github.io/tweet_parser/</a>.
The package is open-source and available on GitHub at
<a class="reference external" href="https://github.com/twitterdev/tweet_parser">https://github.com/twitterdev/tweet_parser</a>. Feel free to submit issues
or make pull requests.</p>
<p>The <code class="docutils literal"><span class="pre">Tweet</span></code> object has properties that allow you to access useful
elements of a Tweet without dealing with its format. For instance, we
can access the text of a Tweet with:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># there are several different methods that access some portion of the text of a Tweet</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Literally the content of the &#39;text&#39; field: </span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">results_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Other fields, like the content of a quoted tweet or the options of a poll: </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">results_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">quoted_tweet</span><span class="o">.</span><span class="n">text</span> <span class="k">if</span> <span class="n">results_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">quoted_tweet</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">results_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">poll_options</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Literally</span> <span class="n">the</span> <span class="n">content</span> <span class="n">of</span> <span class="n">the</span> <span class="s1">&#39;text&#39;</span> <span class="n">field</span><span class="p">:</span>
<span class="n">Left</span> <span class="k">for</span> <span class="n">airport</span> <span class="n">at</span> <span class="mi">4</span><span class="p">:</span><span class="mi">45</span><span class="n">AM</span><span class="p">,</span> <span class="n">pleased</span> <span class="n">to</span> <span class="n">see</span> <span class="c1">#defcon hackers still partying at Caesars bars. Not pleased to be heading to airport at 4:45AM.</span>

<span class="n">Other</span> <span class="n">fields</span><span class="p">,</span> <span class="n">like</span> <span class="n">the</span> <span class="n">content</span> <span class="n">of</span> <span class="n">a</span> <span class="n">quoted</span> <span class="n">tweet</span> <span class="ow">or</span> <span class="n">the</span> <span class="n">options</span> <span class="n">of</span> <span class="n">a</span> <span class="n">poll</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[]</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># as the Twitter platform changes, so do the fields in the data payload.</span>
<span class="c1"># for instance, &quot;extended&quot; and &quot;truncated&quot; tweets have been introduced to stop 280 character from causing</span>
<span class="c1"># breaking changes</span>
<span class="c1"># the Tweet object has a conveinence property &quot;.all_text&quot; that gets &quot;all&quot; the text that a Tweet displays</span>
<span class="n">results_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">all_text</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="s1">&#39;Left for airport at 4:45AM, pleased to see #defcon hackers still partying at Caesars bars. Not pleased to be heading to airport at 4:45AM.&#39;</span>
</pre></div>
</div>
<p>I&#8217;m not going to dive into detail on every property of <code class="docutils literal"><span class="pre">Tweet</span></code> that I
use in this notebook, but hopefully you get the idea. When I call
<code class="docutils literal"><span class="pre">.something</span></code> on a <code class="docutils literal"><span class="pre">Tweet</span></code>, that <code class="docutils literal"><span class="pre">.something</span></code> is provided in the
<code class="docutils literal"><span class="pre">tweet_parser</span></code> package and documented there.</p>
<p>For now, I will describe the elements of the payload that I&#8217;m going to
use in this analysis.</p>
<ul class="simple">
<li><strong>time</strong>: The time that a Tweet was created. This is always reported
in UTC in the Tweet payload, and you can look for the user&#8217;s timezone
in the &#8220;user&#8221; portion of a Tweet payload if you want to translate
this time to the user&#8217;s time-of-day. A string of time information can
be found in the <code class="docutils literal"><span class="pre">created_at</span></code> element of a Tweet, but since we&#8217;re
using the <code class="docutils literal"><span class="pre">tweet_parser</span></code> package, we can access a Python datetime
object with <code class="docutils literal"><span class="pre">tweet.created_at_datetime</span></code> or an integer representing
seconds since Jan 1, 1970 with <code class="docutils literal"><span class="pre">tweet.created_at_seconds</span></code>.</li>
<li><strong>user</strong>: The user who created the Tweet. The &#8220;user&#8221; portion of a
Tweet payload contains many valuable elements, including the user&#8217;s
id (<code class="docutils literal"><span class="pre">tweet[&quot;user&quot;][&quot;id&quot;]</span></code>, or <code class="docutils literal"><span class="pre">tweet.user_id</span></code> with the
<code class="docutils literal"><span class="pre">tweet_parser</span></code> package), the user&#8217;s screen name
(<code class="docutils literal"><span class="pre">tweet.screen_name</span></code>, keep in mind that the user name may change),
the user&#8217;s timezone, potentially their derived location, their bio (a
user-entered description at, <code class="docutils literal"><span class="pre">tweet.bio</span></code>) and more.</li>
<li><strong>text</strong>: The text of the Tweet. As Tweets get more complex
(Retweets, Quote Tweets, poll Tweets, Tweets with hidden &#64;-mentions
and links), the text that you read in a Tweet can appear in many
different areas of a Tweet payload. Here I choose to use the
<code class="docutils literal"><span class="pre">tweet_parser</span></code>-provided attribute <code class="docutils literal"><span class="pre">tweet.all_text</span></code>, which
aggregates all of the possible text fields of a Tweet (the quoted
text, the poll text, the hidden &#64;-mentions, etc) into one string.</li>
<li><strong>hashtags</strong>: Tweet payloads contain a field that list hashtags
present in the Tweet (you do not have to parse them out yourself).
The <code class="docutils literal"><span class="pre">tweet_parser</span></code> Tweet attribute <code class="docutils literal"><span class="pre">tweet.hashtags</span></code> provides a
list of hashtags.</li>
<li><strong>mentions</strong>: You don&#8217;t have to parse out &#64;-mentions yourself either.
Use <code class="docutils literal"><span class="pre">tweet.user_mentions</span></code> for a list of users (names and ids)
mentioned in a Tweet.</li>
<li><strong>URLs</strong>: Many Tweet contain links to outside sources, articles or
media. You can pull the literal link text from a Tweet, or use
Twitter&#8217;s URL enrichments (if you&#8217;ve purchased them) to unroll URLs
and get insight into the linked content.</li>
<li><strong>geo</strong>: For the small sample of Tweets where explicit lat/lon geo
data is available, use <code class="docutils literal"><span class="pre">tweet.geo_coordinates</span></code> to get locations.</li>
</ul>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># if you&#39;re not familiar with pandas, it&#39;s a data analysis python framework and a tool that we use a lot</span>
<span class="c1"># I&#39;d recommend checking out [docs] when you&#39;re done here to familiraize yourself a little</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># make a pandas dataframe</span>
<span class="n">data_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span><span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">created_at_datetime</span><span class="p">,</span>
                         <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">all_text</span><span class="p">,</span>
                         <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">screen_name</span><span class="p">,</span>
                         <span class="s2">&quot;bio&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">bio</span><span class="p">,</span>
                         <span class="s2">&quot;at_mentions&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">u</span><span class="p">[</span><span class="s2">&quot;screen_name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">user_mentions</span><span class="p">],</span>
                         <span class="s2">&quot;hashtags&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">hashtags</span><span class="p">,</span>
                         <span class="s2">&quot;urls&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">most_unrolled_urls</span><span class="p">,</span>
                         <span class="s2">&quot;geo&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">geo_coordinates</span><span class="p">,</span>
                         <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">tweet_type</span><span class="p">,</span>
                         <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">id</span><span class="p">}</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results_list</span><span class="p">])</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="before-you-read-these-tweets">
<h3>Before you read these Tweets<a class="headerlink" href="#before-you-read-these-tweets" title="Permalink to this headline">Â¶</a></h3>
<p>You&#8217;re going to look at this Tweet data and you (should) feel a little
sad. We did all that work talking about rules, you&#8217;ve heard so much
about Twitter data, and these Tweets mostly don&#8217;t seem relevant to our
usecase at all. They&#8217;re not from our target audience (people flying on
planes) and they&#8217;re not even necessarily about plane trips. What gives?</p>
<p>There&#8217;s a reason we started out with only one API call: we didn&#8217;t want
to waste calls pulling Tweets using an unrefined ruleset. This notebook
is going to be about making better decisions about rules, iterating, and
refining them until you get the Tweets that you want. And those Tweets
are out there, I promise. There are, after all, <em>lots</em> of Tweets.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># data, parsed out and ready to analyze</span>
<span class="n">data_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>at_mentions</th>
      <th>bio</th>
      <th>geo</th>
      <th>hashtags</th>
      <th>id</th>
      <th>text</th>
      <th>type</th>
      <th>urls</th>
      <th>user</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-07-31 23:59:59</th>
      <td>[]</td>
      <td>davrik</td>
      <td>None</td>
      <td>[defcon]</td>
      <td>892173026116202498</td>
      <td>Left for airport at 4:45AM, pleased to see #de...</td>
      <td>tweet</td>
      <td>[]</td>
      <td>0davrik</td>
    </tr>
    <tr>
      <th>2017-07-31 23:59:58</th>
      <td>[God1stAmerica2d]</td>
      <td>Proudly Politically Incorrect. Widow of US Mar...</td>
      <td>None</td>
      <td>[]</td>
      <td>892173019040202752</td>
      <td>Why is this even a question. ID needed for lic...</td>
      <td>retweet</td>
      <td>[https://twitter.com/i/web/status/892144209418...</td>
      <td>AliasHere</td>
    </tr>
    <tr>
      <th>2017-07-31 23:59:57</th>
      <td>[LPLdirect]</td>
      <td>ðŸ‡¬ðŸ‡³ðŸ‡ºðŸ‡¸</td>
      <td>None</td>
      <td>[Algerie]</td>
      <td>892173017186435073</td>
      <td>ðŸ”´INFOS #Algerie\n\nDeux pilotes d' Air AlgÃ©rie...</td>
      <td>retweet</td>
      <td>[https://twitter.com/i/web/status/892152194920...</td>
      <td>Wyzzyddl</td>
    </tr>
    <tr>
      <th>2017-07-31 23:59:57</th>
      <td>[Simbaki_]</td>
      <td>ðŸ³ï¸â€ðŸŒˆ sc : kailabrielleeee / match ?</td>
      <td>None</td>
      <td>[]</td>
      <td>892173016372838400</td>
      <td>We are unappreciative... we don't deserve Take...</td>
      <td>retweet</td>
      <td>[]</td>
      <td>KailaBrielleee_</td>
    </tr>
    <tr>
      <th>2017-07-31 23:59:56</th>
      <td>[realDonaldTrump]</td>
      <td>follower of Christ â€¢ Consultant â€¢ ðŸ’» Engineer â€¢...</td>
      <td>None</td>
      <td>[]</td>
      <td>892173013625573376</td>
      <td>@realDonaldTrump Watch Trump get lost going fr...</td>
      <td>quote</td>
      <td>[https://twitter.com/i/web/status/892173013625...</td>
      <td>LoveRunandPray</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="section" id="describe-your-data">
<h2>3. Describe your data<a class="headerlink" href="#describe-your-data" title="Permalink to this headline">Â¶</a></h2>
<p>Descriptive statistics can tell you a lot about your dataset with very
little special effort and customization. Having a good set of
descriptive statistics coded up that you always run on a new dataset can
be helpful. Our team maintains
<a class="reference external" href="https://github.com/tw-ddis/Gnip-Tweet-Evaluation">Gnip-Tweet-Evaluation</a>
a repository on GitHub that contains some tools to do quick evaluation
of a Tweet corpus (that package is useful as a command line tool, and as
a template for Tweet evaluation).</p>
<p>I&#8217;m going to walk through a few different statistics that might help us
understand the data better: - <strong>What is generating the Tweets?</strong>: One
statistic that is common and useful in understanding a group of Tweets
is understanding how many of them are Retweets or quote Tweets. Another
interesting data point can be looking at the application that created
the Tweet itself. - <strong>Common words</strong>: What are the most common words in
the corpus? Are they what we expected? Are they relevant to the topic of
interest? - <strong>Who is Tweeting</strong>: Who are the users who Tweet the most?
Are there spammy users that should be removed? Are they important users
that we need to pay attention to? - <strong>Where are they Tweeting from</strong>:
What&#8217;s the distribution of Tweet locations? Is that surprising? - <strong>Time
series</strong>: Are there spikes in the Tweet volume? When do they occur? What
drives the spikes? For the sake of filtering out noise (or news stories
that we don&#8217;t care about) it may be important to identify spikes and
filter out the Tweets that drive those spikes.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># plotting library</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;bmh&quot;</span><span class="p">)</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
</pre></div>
</div>
<div class="section" id="how-are-people-tweeting">
<h3>How are people Tweeting?<a class="headerlink" href="#how-are-people-tweeting" title="Permalink to this headline">Â¶</a></h3>
<p>Briefly, I&#8217;d like to note that there are several different Twitter
platform actions that can create a Tweet. - <strong>original Tweet</strong>: the user
created a Tweet by typing it into the Tweet create box or otherwise
hitting the <code class="docutils literal"><span class="pre">statuses/update</span></code> endpoint - <strong>Retweet</strong>: the user
reposted the Tweet to their own timeline, without adding and comment -
<strong>Quote Tweet</strong>: user added commentary to a reposted Tweet, essentially
a Tweet with another Tweet embedded in it</p>
<p>This is sometimes an important distinction: how much do Retweets or
Quote Tweets represent the experience of the user reposting? Do we
actually want Retweets in our particular dataset? Are they likely to
tell us anything about users who are actually travelling (put it this
way: if a user Retweets a story about being at an airport, how likely
does it seem that they are at an airport)?</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">data_df</span><span class="p">[[</span><span class="s2">&quot;type&quot;</span><span class="p">,</span><span class="s2">&quot;id&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
    </tr>
    <tr>
      <th>type</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>quote</th>
      <td>16</td>
    </tr>
    <tr>
      <th>retweet</th>
      <td>294</td>
    </tr>
    <tr>
      <th>tweet</th>
      <td>190</td>
    </tr>
  </tbody>
</table>
</div></div>
<div class="section" id="common-words">
<h3>Common words<a class="headerlink" href="#common-words" title="Permalink to this headline">Â¶</a></h3>
<p>Definitions: - <strong>corpus</strong>: A collection of all of the documents that we
are analyzing. - <strong>document</strong>: A single piece of writing, in our case, a
single Tweet - <strong>token</strong>: Some characters from a document. Ideally,
tokens would be common enough to occur in many documents, and have some
semantic meaning&#8211;they provide us with a way to infer semantic
correlation across documents. - <strong>stop word</strong>: A stop word (something
like &#8220;and&#8221;,&#8221;but&#8221;,&#8221;the&#8221;) is a very common word with little semantic
meaning, and we often exclude these words from word counts or NLP
models.</p>
</div>
<div class="section" id="tokenization">
<h3>Tokenization<a class="headerlink" href="#tokenization" title="Permalink to this headline">Â¶</a></h3>
<p>In order to count common terms, first we have to define our terms. The
easiest thing for me to count is a token&#8211;a single unit of characters in
a Tweet. Often we try to define tokens so that a token is basically a
word.</p>
<p>I&#8217;m going to tokenize the Tweets (split each Tweet into a list of
tokens) using the <a class="reference external" href="http://www.nltk.org/api/nltk.tokenize.html#module-nltk.tokenize.casual">nltk
TweetTokenizer</a>,
which splits on spaces and throws away some punctuation. I&#8217;m also going
to throw away any tokens that contain no letters, and throw away any
tokens that are less than 3 characters long. These choices&#8211;how to
define a token, and which tokens to count, are somewhat arbitrary, but
depend greatly on how language is used in the dataset. For instance,
many tokenizers would remove the symbols &#8220;&#64;&#8221; and &#8220;#&#8221; as punctuation, but
on Twitter, those symbols have important semantic meaning, and should
perhaps be preserved.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nltk.tokenize</span> <span class="k">import</span> <span class="n">TweetTokenizer</span>
<span class="kn">from</span> <span class="nn">nltk.stem.porter</span> <span class="k">import</span> <span class="n">PorterStemmer</span>

<span class="k">def</span> <span class="nf">tweet_tokenizer</span><span class="p">(</span><span class="n">verbatim</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">TweetTokenizer</span><span class="p">()</span>
        <span class="n">all_tokens</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">verbatim</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="c1"># this line filters out all tokens that are entirely non-alphabetic characters</span>
        <span class="n">filtered_tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_tokens</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">islower</span><span class="p">()]</span>
        <span class="c1"># filter out all tokens that are &lt;=2 chars</span>
        <span class="n">filtered_tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">filtered_tokens</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="n">filtered_tokens</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">return</span><span class="p">(</span><span class="n">filtered_tokens</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="counting">
<h3>Counting<a class="headerlink" href="#counting" title="Permalink to this headline">Â¶</a></h3>
<p>Of course, we could simply create a dictionary of tokens in our corpus
and iterate through the entire corpus of Tweets and adding &#8220;1&#8221; to a
count every time we encounter a certain token, but it&#8217;s more convenient
to start using the scikit-learn API now and put our token counts into a
format that&#8217;s easy to use later. If you&#8217;re unfamiliar with scikit-learn,
it is an excellent Python machine learning framework that implements
many common ML algorithms in a common building-block-able API.</p>
<p>I am going to use <a class="reference external" href="http://scikit-learn.org/stable/modules/generated/sklearn.feature_extraction.text.CountVectorizer.html">scikit-learn&#8217;s
CountVectorizer</a>
to count tokens and turn the corpus into a document-term matrix. This
makes it easy to count token frequencies. Note that the CountVectorizer
allows us to count not only terms (&#8220;tokens&#8221;) but n-grams (collections of
tokens). For instance, if &#8220;plane&#8221; and &#8220;trip&#8221; are both tokens split on
spaces, then explicit phrase &#8220;plane trip&#8221; might be a 2-gram in our
corpus.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># get the most common words in Tweets</span>
<span class="kn">from</span> <span class="nn">sklearn.feature_extraction.text</span> <span class="k">import</span> <span class="n">CountVectorizer</span>

<span class="k">def</span> <span class="nf">get_frequent_terms</span><span class="p">(</span><span class="n">text_series</span><span class="p">,</span> <span class="n">stop_words</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ngram_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)):</span>
    <span class="n">count_vectorizer</span> <span class="o">=</span> <span class="n">CountVectorizer</span><span class="p">(</span><span class="n">analyzer</span> <span class="o">=</span> <span class="s2">&quot;word&quot;</span><span class="p">,</span>
                                       <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tweet_tokenizer</span><span class="p">,</span>
                                       <span class="n">stop_words</span> <span class="o">=</span> <span class="n">stop_words</span><span class="p">,</span> <span class="c1"># try changing the stopword sets that we use.</span>
                                                                <span class="c1"># notice that many top terms are words like</span>
                                                                <span class="c1"># &quot;and&quot; and &quot;the&quot;</span>
                                       <span class="n">ngram_range</span> <span class="o">=</span> <span class="n">ngram_range</span> <span class="c1"># you can change this to count frequencies of</span>
                                                           <span class="c1"># ngrams as well as single tokens</span>
                                                           <span class="c1"># a range of (1,2) counts 1-grams (single tokens) and</span>
                                                           <span class="c1"># 2-grams (2-token phrases)</span>
                                      <span class="p">)</span>
    <span class="n">term_freq_matrix</span> <span class="o">=</span> <span class="n">count_vectorizer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">text_series</span><span class="p">)</span>
    <span class="n">terms</span> <span class="o">=</span> <span class="n">count_vectorizer</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">()</span>
    <span class="n">term_frequencies</span> <span class="o">=</span> <span class="n">term_freq_matrix</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">term_freq_df</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">terms</span><span class="p">,</span> <span class="n">term_frequencies</span><span class="p">)),</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;token&quot;</span><span class="p">,</span><span class="s2">&quot;count&quot;</span><span class="p">])</span>
                    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;token&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">,</span><span class="n">ascending</span> <span class="o">=</span> <span class="kc">False</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">term_freq_df</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">term_freq_df</span> <span class="o">=</span> <span class="n">get_frequent_terms</span><span class="p">(</span><span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span>
                                  <span class="n">stop_words</span> <span class="o">=</span> <span class="s2">&quot;english&quot;</span><span class="p">)</span> <span class="c1"># stop_words = &quot;english&quot; removes words like &#39;and&#39;</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">term_freq_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
    </tr>
    <tr>
      <th>token</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>airport</th>
      <td>195</td>
    </tr>
    <tr>
      <th>flying</th>
      <td>124</td>
    </tr>
    <tr>
      <th>plane</th>
      <td>97</td>
    </tr>
    <tr>
      <th>landed</th>
      <td>45</td>
    </tr>
    <tr>
      <th>today</th>
      <td>30</td>
    </tr>
    <tr>
      <th>just</th>
      <td>29</td>
    </tr>
    <tr>
      <th>home</th>
      <td>29</td>
    </tr>
    <tr>
      <th>trump</th>
      <td>27</td>
    </tr>
    <tr>
      <th>harry</th>
      <td>27</td>
    </tr>
    <tr>
      <th>flight</th>
      <td>24</td>
    </tr>
    <tr>
      <th>got</th>
      <td>24</td>
    </tr>
    <tr>
      <th>flying home</th>
      <td>23</td>
    </tr>
    <tr>
      <th>meeting</th>
      <td>23</td>
    </tr>
    <tr>
      <th>i'm</th>
      <td>22</td>
    </tr>
    <tr>
      <th>initial</th>
      <td>22</td>
    </tr>
    <tr>
      <th>g20</th>
      <td>21</td>
    </tr>
    <tr>
      <th>dictated</th>
      <td>21</td>
    </tr>
    <tr>
      <th>way</th>
      <td>21</td>
    </tr>
    <tr>
      <th>statement</th>
      <td>21</td>
    </tr>
    <tr>
      <th>son's</th>
      <td>20</td>
    </tr>
  </tbody>
</table>
</div><div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">term_freq_df</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
    </tr>
    <tr>
      <th>token</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>flying https://t.co/lsdvzywfrr</th>
      <td>1</td>
    </tr>
    <tr>
      <th>flying https://t.co/ofhqdrxzxd</th>
      <td>1</td>
    </tr>
    <tr>
      <th>flying https://t.co/yez213svuo</th>
      <td>1</td>
    </tr>
    <tr>
      <th>flying i'm</th>
      <td>1</td>
    </tr>
    <tr>
      <th>flying job</th>
      <td>1</td>
    </tr>
    <tr>
      <th>flying kiss</th>
      <td>1</td>
    </tr>
    <tr>
      <th>flying kisses</th>
      <td>1</td>
    </tr>
    <tr>
      <th>flying machines</th>
      <td>1</td>
    </tr>
    <tr>
      <th>flying monkey</th>
      <td>1</td>
    </tr>
    <tr>
      <th>è•¾é˜¿è•¾ä¸¶elahe https://t.co/y74vcswiuq</th>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div></div>
<div class="section" id="hand-labeling">
<h3>Hand labeling<a class="headerlink" href="#hand-labeling" title="Permalink to this headline">Â¶</a></h3>
<p>I&#8217;m not going to walk through the process in this notebook, but never
underestimate the value of reading through your data. Actually look at
the terms in the Tweets. Identify the Tweets that look like ones you are
actually interested in.</p>
</div>
<div class="section" id="who-is-tweeting-who-is-speaking">
<h3>Who is Tweeting? Who is speaking?<a class="headerlink" href="#who-is-tweeting-who-is-speaking" title="Permalink to this headline">Â¶</a></h3>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># get the most commonly Tweeting users</span>
<span class="c1"># I&#39;m using Pandas functionality here to groupby and aggregate</span>
<span class="c1"># read the pandas docs for more information:</span>
<span class="c1">#         http://pandas.pydata.org/pandas-docs/stable/groupby.html</span>
<span class="p">(</span><span class="n">data_df</span><span class="p">[[</span><span class="s2">&quot;user&quot;</span><span class="p">,</span><span class="s2">&quot;bio&quot;</span><span class="p">,</span><span class="s2">&quot;geo&quot;</span><span class="p">,</span><span class="s2">&quot;id&quot;</span><span class="p">]]</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;count&quot;</span><span class="p">,</span><span class="s2">&quot;bio&quot;</span><span class="p">:</span><span class="s2">&quot;first&quot;</span><span class="p">,</span><span class="s2">&quot;geo&quot;</span><span class="p">:</span><span class="s2">&quot;first&quot;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span><span class="n">ascending</span> <span class="o">=</span> <span class="kc">False</span><span class="p">))</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
</pre></div>
</div>
<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>bio</th>
      <th>geo</th>
    </tr>
    <tr>
      <th>user</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>babyieturtle</th>
      <td>6</td>
      <td>ELF | YG/RapperðŸŒ¸</td>
      <td>None</td>
    </tr>
    <tr>
      <th>P3air</th>
      <td>3</td>
      <td>Worldwide insurance approved King Air Flight S...</td>
      <td>None</td>
    </tr>
    <tr>
      <th>RPMSports18</th>
      <td>2</td>
      <td>24. University of South Alabama alum. Just liv...</td>
      <td>None</td>
    </tr>
    <tr>
      <th>heskiwi94x</th>
      <td>2</td>
      <td>An adult fangirl &amp;attended too many concerts. ...</td>
      <td>None</td>
    </tr>
    <tr>
      <th>CollectedN</th>
      <td>2</td>
      <td>Various News, Videos, Opinions.</td>
      <td>None</td>
    </tr>
    <tr>
      <th>Spotiflynet</th>
      <td>2</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>DaveDuFourNBA</th>
      <td>2</td>
      <td>Basketball Coach, Host "On the NBA with Dave D...</td>
      <td>None</td>
    </tr>
    <tr>
      <th>thunderzsx</th>
      <td>2</td>
      <td>à¸ªà¸²à¸¢à¸«à¸¡à¸µ.</td>
      <td>None</td>
    </tr>
    <tr>
      <th>remypost</th>
      <td>2</td>
      <td>im remy | he/him | 22 | i play literally all o...</td>
      <td>None</td>
    </tr>
    <tr>
      <th>___13Dec</th>
      <td>2</td>
      <td>Taylor swift. | H. | The 1975. | Kodaline. | C...</td>
      <td>None</td>
    </tr>
    <tr>
      <th>EdyAntal</th>
      <td>2</td>
      <td>S A D  B O Y S</td>
      <td>None</td>
    </tr>
    <tr>
      <th>pdougmc</th>
      <td>2</td>
      <td>Retired, Interests: Gardening, photography, cl...</td>
      <td>None</td>
    </tr>
    <tr>
      <th>billsplacehere</th>
      <td>2</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>hopia0218</th>
      <td>1</td>
      <td>@BTS_twt BTS x A.R.M.Y. \n#LOVE_YOURSELF #LOVE...</td>
      <td>None</td>
    </tr>
    <tr>
      <th>hollythomp__</th>
      <td>1</td>
      <td>http://Instagram.com/hollythomp__/</td>
      <td>None</td>
    </tr>
  </tbody>
</table>
</div></div>
<div class="section" id="time-series-plot">
<h3>Time series plot<a class="headerlink" href="#time-series-plot" title="Permalink to this headline">Â¶</a></h3>
<p>Another great way to get a broader picture of our data is to understand
when people are tweeting about these keywords. Now, recall that earlier
we only grabbed a tiny sample of data, so those Tweets only cover a few
minutes of activity&#8211;not a good way to build a time series. If you have
access to the enterprise level API, you will be able to make an API call
to the <a class="reference external" href="https://developer.twitter.com/en/docs/tweets/search/overview/enterprise">counts
endpoint</a>
to retrieve a time series <em>without</em> needing to use many calls to
retrieve all Tweets over a time period. Let&#8217;s try it out.</p>
</div>
<div class="section" id="counts-endpoint">
<h3>Counts endpoint<a class="headerlink" href="#counts-endpoint" title="Permalink to this headline">Â¶</a></h3>
<p>The counts endpoint has exactly the same API as the search endpoint, but
instead of returning Tweets, it returns counts of Tweets. This is
especially useful when you want to quickly assess a large dataset
without retrieving a lot of data.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># use the same &quot;_rule&quot; string</span>
<span class="kn">from</span> <span class="nn">twittersearch</span> <span class="k">import</span> <span class="n">change_to_count_endpoint</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Recall, our rule is: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_rule_a</span><span class="p">))</span>
<span class="n">count_rule_a</span> <span class="o">=</span> <span class="n">gen_rule_payload</span><span class="p">(</span><span class="n">_rule_a</span><span class="p">,</span>
                        <span class="n">from_date</span><span class="o">=</span><span class="s2">&quot;2017-07-01&quot;</span><span class="p">,</span>
                        <span class="n">to_date</span><span class="o">=</span><span class="s2">&quot;2017-08-01&quot;</span><span class="p">,</span>
                        <span class="n">results_per_call</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                        <span class="n">count_bucket</span><span class="o">=</span><span class="s2">&quot;hour&quot;</span><span class="p">)</span>

<span class="c1"># the endpoint changes slightly to the &quot;counts&quot; endpoint</span>
<span class="n">count_args</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">search_args</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s2">&quot;endpoint&quot;</span><span class="p">:</span> <span class="n">change_to_count_endpoint</span><span class="p">(</span><span class="n">search_args</span><span class="p">[</span><span class="s2">&quot;endpoint&quot;</span><span class="p">])}}</span>

<span class="n">counts_list</span> <span class="o">=</span> <span class="n">collect_results</span><span class="p">(</span><span class="n">count_rule_a</span><span class="p">,</span> <span class="n">max_results</span><span class="o">=</span><span class="mi">24</span><span class="o">*</span><span class="mi">31</span><span class="p">,</span> <span class="n">result_stream_args</span><span class="o">=</span><span class="n">count_args</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Recall</span><span class="p">,</span> <span class="n">our</span> <span class="n">rule</span> <span class="ow">is</span><span class="p">:</span> <span class="p">(</span><span class="n">flying</span> <span class="n">OR</span> <span class="n">plane</span> <span class="n">OR</span> <span class="n">landed</span> <span class="n">OR</span> <span class="n">airport</span> <span class="n">OR</span> <span class="n">takeoff</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># this is what our counts_list looks like: a count and a (UTC!) timestamp</span>
<span class="n">counts_list</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[{</span><span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="mi">9105</span><span class="p">,</span> <span class="s1">&#39;timePeriod&#39;</span><span class="p">:</span> <span class="s1">&#39;201707312300&#39;</span><span class="p">},</span>
 <span class="p">{</span><span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="mi">10024</span><span class="p">,</span> <span class="s1">&#39;timePeriod&#39;</span><span class="p">:</span> <span class="s1">&#39;201707312200&#39;</span><span class="p">},</span>
 <span class="p">{</span><span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="mi">9376</span><span class="p">,</span> <span class="s1">&#39;timePeriod&#39;</span><span class="p">:</span> <span class="s1">&#39;201707312100&#39;</span><span class="p">},</span>
 <span class="p">{</span><span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="mi">9927</span><span class="p">,</span> <span class="s1">&#39;timePeriod&#39;</span><span class="p">:</span> <span class="s1">&#39;201707312000&#39;</span><span class="p">},</span>
 <span class="p">{</span><span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="mi">9426</span><span class="p">,</span> <span class="s1">&#39;timePeriod&#39;</span><span class="p">:</span> <span class="s1">&#39;201707311900&#39;</span><span class="p">}]</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># plot a timeseries of the Tweet counts</span>
<span class="n">tweet_counts_original</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">counts_list</span><span class="p">)</span>
     <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">time_bucket</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;timePeriod&quot;</span><span class="p">]))</span>
     <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;timePeriod&quot;</span><span class="p">,</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
     <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;time_bucket&quot;</span><span class="p">)</span>
     <span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="p">(</span><span class="n">tweet_counts_original</span>
 <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
       <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Count of Tweets per hour&quot;</span><span class="p">,</span>
       <span class="n">legend</span> <span class="o">=</span> <span class="kc">False</span><span class="p">));</span>
<span class="p">(</span><span class="n">tweet_counts_original</span>
 <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">)</span>
 <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
 <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
       <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Count of Tweets per day&quot;</span><span class="p">,</span>
       <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">));</span>
</pre></div>
</div>
<img alt="_images/collecting-and-filtering-tweets-draft_39_0.png" src="_images/collecting-and-filtering-tweets-draft_39_0.png" />
</div>
<div class="section" id="how-can-we-use-this-information-to-understand-our-search-data">
<h3>How can we use this information to understand our search data?<a class="headerlink" href="#how-can-we-use-this-information-to-understand-our-search-data" title="Permalink to this headline">Â¶</a></h3>
<p>Consider the type of Tweets that we are looking for: we&#8217;re looking for
Tweets from people who are talking about air travel, hopefully people
talking about their own experiences using air travel. It&#8217;s pretty likely
that air travel has a relatively regular pattern, with probably some big
seasonal fluctuations (Thanksgiving?) and some daily fluctuations
(people fly, for the most part during the day); it&#8217;s unlikely that 2 or
3 times as many people fly on any given Monday vs the Mondays around it.</p>
<p>We can use an intuition about what spikes mean in our data to either
filter out high volume noise, or, in the case where spikes are what we
are seeking out (say we wanted the audience for a movie release that
happens on a specific day), zooming in on important time periods.</p>
<p>Let&#8217;s choose a few large spikes in this data and investigate further,
then exclude that topic from our final Twitter dataset.</p>
</div>
<div class="section" id="id1">
<h3>Note:<a class="headerlink" href="#id1" title="Permalink to this headline">Â¶</a></h3>
<p>If you don&#8217;t have access to the counts API, I would still recommend
taking a few small, time-boxed samples of data across the entire period
that you&#8217;re interested in and doing the same exercise. It&#8217;s harder to
specifically target spikes, but it will help you get a broader sample of
data.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># you can look at the plots to get a sense of what the highest-volume tiem periods are, or just sort your dataframe</span>
<span class="p">(</span><span class="n">tweet_counts_original</span>
 <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">)</span>
 <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
 <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span> <span class="o">=</span> <span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="n">ascending</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
 <span class="o">.</span><span class="n">head</span><span class="p">())</span>
</pre></div>
</div>
<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
    </tr>
    <tr>
      <th>time_bucket</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-07-17</th>
      <td>337743</td>
    </tr>
    <tr>
      <th>2017-07-26</th>
      <td>304237</td>
    </tr>
    <tr>
      <th>2017-07-14</th>
      <td>288738</td>
    </tr>
    <tr>
      <th>2017-07-18</th>
      <td>279771</td>
    </tr>
    <tr>
      <th>2017-07-29</th>
      <td>262412</td>
    </tr>
  </tbody>
</table>
</div><div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># let&#39;s look at the highest volume day</span>
<span class="n">spike_rule_717</span> <span class="o">=</span> <span class="n">gen_rule_payload</span><span class="p">(</span><span class="n">_rule_a</span><span class="p">,</span> <span class="c1">#&lt;-remember, same rule</span>
                              <span class="n">from_date</span><span class="o">=</span><span class="s2">&quot;2017-07-17&quot;</span><span class="p">,</span>
                              <span class="n">to_date</span><span class="o">=</span><span class="s2">&quot;2017-07-18&quot;</span><span class="p">,</span>
                              <span class="n">results_per_call</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span> <span class="c1"># the max_results parameter sets</span>
                                               <span class="c1"># the number of Tweets I receive per API call.</span>
                                               <span class="c1"># this value can be at most 500</span>

<span class="n">spike_results_list_717</span> <span class="o">=</span> <span class="n">collect_results</span><span class="p">(</span><span class="n">spike_rule_717</span><span class="p">,</span> <span class="n">max_results</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">result_stream_args</span><span class="o">=</span><span class="n">search_args</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># what are these Tweets about?</span>
<span class="n">get_frequent_terms</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">all_text</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spike_results_list_717</span><span class="p">],</span>
                   <span class="n">stop_words</span> <span class="o">=</span> <span class="s2">&quot;english&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
    </tr>
    <tr>
      <th>token</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>got</th>
      <td>449</td>
    </tr>
    <tr>
      <th>flying</th>
      <td>270</td>
    </tr>
    <tr>
      <th>security</th>
      <td>223</td>
    </tr>
    <tr>
      <th>instead</th>
      <td>222</td>
    </tr>
    <tr>
      <th>flying cars</th>
      <td>220</td>
    </tr>
    <tr>
      <th>cars</th>
      <td>220</td>
    </tr>
    <tr>
      <th>office</th>
      <td>219</td>
    </tr>
    <tr>
      <th>robot</th>
      <td>218</td>
    </tr>
    <tr>
      <th>instead got</th>
      <td>218</td>
    </tr>
    <tr>
      <th>robots</th>
      <td>218</td>
    </tr>
    <tr>
      <th>robot drowned</th>
      <td>218</td>
    </tr>
    <tr>
      <th>security robot</th>
      <td>218</td>
    </tr>
    <tr>
      <th>office building</th>
      <td>218</td>
    </tr>
    <tr>
      <th>got security</th>
      <td>218</td>
    </tr>
    <tr>
      <th>suicidal robots</th>
      <td>218</td>
    </tr>
    <tr>
      <th>cars instead</th>
      <td>218</td>
    </tr>
    <tr>
      <th>building</th>
      <td>218</td>
    </tr>
    <tr>
      <th>drowned promised</th>
      <td>218</td>
    </tr>
    <tr>
      <th>promised flying</th>
      <td>218</td>
    </tr>
    <tr>
      <th>promised</th>
      <td>218</td>
    </tr>
  </tbody>
</table>
</div><div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># It&#39;s sometimes important to get the context of a full Tweet</span>
<span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">all_text</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spike_results_list_717</span> <span class="k">if</span> <span class="s2">&quot;international&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">all_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="s1">&#39;Greater Southwest International (KGSW / GSW) airport has been opened #AWS #gameStatus #GW2&#39;</span><span class="p">,</span>
 <span class="s1">&#39;BREAKING: Fire emergency @RDUAirport Raleigh Durham international airport entire airport being evaluated https://t.co/sCVOUvlq3J&#39;</span><span class="p">,</span>
 <span class="s1">&#39;BREAKING: Fire emergency @RDUAirport Raleigh Durham international airport entire airport being evaluated https://t.co/sCVOUvlq3J&#39;</span><span class="p">,</span>
 <span class="s1">&#39;BREAKING: Fire emergency @RDUAirport Raleigh Durham international airport entire airport being evaluated https://t.co/sCVOUvlq3J&#39;</span><span class="p">,</span>
 <span class="s1">&#39;Goodbye #merauke semoga bisa berkunjung kembali #papua @ Mopah International Airport https://t.co/0cH3IsUNUx&#39;</span><span class="p">,</span>
 <span class="s1">&#39;traveling to Incheon Airport from IGIA T3:  Indira Gandhi International Airport Terminal 3, New Delhi - India https://t.co/WSGheHhyUC&#39;</span><span class="p">,</span>
 <span class="s1">&#39;BREAKING: Fire emergency @RDUAirport Raleigh Durham international airport entire airport being evaluated https://t.co/sCVOUvlq3J&#39;</span><span class="p">,</span>
 <span class="s1">&#39;#MedellÃ­n (@ JosÃ© MarÃ­a CÃ³rdova International Airport - @aeropuertomde in Rionegro, Antioquia) https://t.co/X1FWVYQvJO&#39;</span><span class="p">,</span>
 <span class="s1">&#39;FINALMENTEEEE #PARTIU #ALAGOAS #DEUSNOCONTROLE @ SÃ£o Pauloâ€“Guarulhos International Airport https://t.co/Oeusimjsqy&#39;</span><span class="p">,</span>
 <span class="s1">&#39;Aviation enthusiasts are upset a prime viewing spot near Ottawa International Airport @FlyYOW has been closed off. https://t.co/YPMXs2xeP5 https://t.co/KnN7YZHBMV&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="p">[(</span><span class="n">x</span><span class="o">.</span><span class="n">all_text</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">tweet_type</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spike_results_list_717</span> <span class="k">if</span> <span class="s2">&quot;anncoulter&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">all_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
<pre class="literal-block">
[('Flying with my friends &#64;Delta from SFO tomorrow and proud they treated &#64;AnnCoulter like the dog she is.',
  'tweet'),
 (&quot;ON PLANE &amp;amp; CAN'T BELIEVE MY SEAT IS MISSING THE IN-FLIGHT MAGAZINE! Just kidding, I'm not unhinged like &#64;AnnCoulter by minor inconveniences. <a class="reference external" href="https://t.co/6jzB8lkc9A">https://t.co/6jzB8lkc9A</a>&quot;,
  'retweet'),
 (<a class="reference external" href="mailto:'&#37;&#52;&#48;GixGidea">'<span>&#64;</span>GixGidea</a> True...nnNever mind, &#64;AnnCoulter. Carry on bitching about completely trivial plane fares you were refunded. Go nuts-like squirrel turd nuts.',
  'tweet'),
 (<a class="reference external" href="mailto:'&#37;&#52;&#48;CWSmets">'<span>&#64;</span>CWSmets</a> &#64;jasondashbailey &#64;AnnCoulter To be fair, I think &quot;investigate&quot; means making sure there are no non-white people flying the plane.',
  'tweet'),
 (&quot;ON PLANE &amp;amp; CAN'T BELIEVE MY SEAT IS MISSING THE IN-FLIGHT MAGAZINE! Just kidding, I'm not unhinged like &#64;AnnCoulter by minor inconveniences. <a class="reference external" href="https://t.co/6jzB8lkc9A">https://t.co/6jzB8lkc9A</a>&quot;,
  'retweet')]
</pre>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># let&#39;s look at the highest volume day</span>
<span class="n">spike_rule_726</span> <span class="o">=</span> <span class="n">gen_rule_payload</span><span class="p">(</span><span class="n">_rule_a</span><span class="p">,</span> <span class="c1">#&lt;-remember, same rule</span>
                              <span class="n">from_date</span><span class="o">=</span><span class="s2">&quot;2017-07-26&quot;</span><span class="p">,</span>
                              <span class="n">to_date</span><span class="o">=</span><span class="s2">&quot;2017-07-27&quot;</span><span class="p">,</span>
                              <span class="n">results_per_call</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span> <span class="c1"># the max_results parameter sets</span>
                                               <span class="c1"># the number of Tweets I receive per API call.</span>
                                               <span class="c1"># this value can be at most 500</span>

<span class="n">spike_results_list_726</span> <span class="o">=</span> <span class="n">collect_results</span><span class="p">(</span><span class="n">spike_rule_726</span><span class="p">,</span> <span class="n">max_results</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">result_stream_args</span><span class="o">=</span><span class="n">search_args</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">get_frequent_terms</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">all_text</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spike_results_list_726</span><span class="p">],</span> <span class="n">stop_words</span> <span class="o">=</span> <span class="s2">&quot;english&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
    </tr>
    <tr>
      <th>token</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>airport</th>
      <td>267</td>
    </tr>
    <tr>
      <th>plane</th>
      <td>130</td>
    </tr>
    <tr>
      <th>gimpo</th>
      <td>117</td>
    </tr>
    <tr>
      <th>gimpo airport</th>
      <td>111</td>
    </tr>
    <tr>
      <th>crash</th>
      <td>69</td>
    </tr>
    <tr>
      <th>tokyo</th>
      <td>67</td>
    </tr>
    <tr>
      <th>flying</th>
      <td>64</td>
    </tr>
    <tr>
      <th>preview</th>
      <td>62</td>
    </tr>
    <tr>
      <th>airport tokyo</th>
      <td>58</td>
    </tr>
    <tr>
      <th>seohyun</th>
      <td>56</td>
    </tr>
    <tr>
      <th>sooyoung</th>
      <td>55</td>
    </tr>
    <tr>
      <th>utah</th>
      <td>48</td>
    </tr>
    <tr>
      <th>small</th>
      <td>48</td>
    </tr>
    <tr>
      <th>small plane</th>
      <td>47</td>
    </tr>
    <tr>
      <th>crash utah</th>
      <td>46</td>
    </tr>
    <tr>
      <th>#news</th>
      <td>46</td>
    </tr>
    <tr>
      <th>highway</th>
      <td>46</td>
    </tr>
    <tr>
      <th>plane die</th>
      <td>45</td>
    </tr>
    <tr>
      <th>https://t.co/sizpfmclq7</th>
      <td>45</td>
    </tr>
    <tr>
      <th>#news #almalki</th>
      <td>45</td>
    </tr>
  </tbody>
</table>
</div><div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="p">[(</span><span class="n">x</span><span class="o">.</span><span class="n">all_text</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">tweet_type</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spike_results_list_726</span> <span class="k">if</span> <span class="s2">&quot;gimpo&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">all_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
<pre class="literal-block">
[('[HD PIC] 170726 Gimpo Airport - Our boys Eunhyuk, Leeteuk and Donghae looking so good in their airport fashion! [3P] (Cr:As Tagged) https://t.co/tKCT7QApsh',
  'retweet'),
 ('170726 Gimpo Airport #Donghae [å¡å¡_kaka_KAKA] https://t.co/UIAgC2SroA',
  'retweet'),
 ('[Preview] 170727 Seohyun - Gimpo airport by seohyuntwunion https://t.co/klNNEAf5Ko',
  'retweet'),
 ('[Preview] 170727 Sooyoung - Gimpo airport by jtt_muk https://t.co/uKrcF8lmNe',
  'retweet'),
 ('[Preview] 170727 Sooyoung - Gimpo airport by jtt_muk https://t.co/uKrcF8lmNe',
  'retweet'),
 ('[Preview] 170727 Seohyun - Gimpo airport by mr_zhang https://t.co/5gAgwJZudT',
  'retweet'),
 ('[PRESS] 170726 Mark at Gimpo airport departures to Tokyo, Japan (2) https://t.co/urWfCgwWJZ',
  'tweet'),
 ('170726 Gimpo airport to Tokyo - Taeyong press pics #NCT127 #íƒœìš© https://t.co/qV3jfRdFuy',
  'retweet'),
 ('170727 Heechul, Shindong at Gimpo Airport going to Japan for #SMTOWNLIVEinTokyo https://t.co/YWHSgX1XZW',
  'retweet'),
 ('170727 Gimpo Airportnn#KimHeechul #Heechul #ê¹€í¬ì²  #í¬ì² nn[ç‰¹çº¸SAMAå’Œå¸Œå¤§äººä¸€èµ·niconiconi] https://t.co/OJgH9EKSSC',
  'retweet')]
</pre>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="p">[(</span><span class="n">x</span><span class="o">.</span><span class="n">all_text</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">tweet_type</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spike_results_list_726</span> <span class="k">if</span> <span class="s2">&quot;utah&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">all_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[(</span><span class="s1">&#39;#News by #almalki : Four aboard small plane die in crash on Utah highway https://t.co/sizPfmclq7&#39;</span><span class="p">,</span>
  <span class="s1">&#39;retweet&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;#News by #almalki : Four aboard small plane die in crash on Utah highway https://t.co/sizPfmclq7&#39;</span><span class="p">,</span>
  <span class="s1">&#39;retweet&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;#News by #almalki : Four aboard small plane die in crash on Utah highway https://t.co/sizPfmclq7&#39;</span><span class="p">,</span>
  <span class="s1">&#39;retweet&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;#News by #almalki : Four aboard small plane die in crash on Utah highway https://t.co/sizPfmclq7&#39;</span><span class="p">,</span>
  <span class="s1">&#39;retweet&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;#News by #almalki : Four aboard small plane die in crash on Utah highway https://t.co/sizPfmclq7&#39;</span><span class="p">,</span>
  <span class="s1">&#39;retweet&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;#News by #almalki : Four aboard small plane die in crash on Utah highway https://t.co/sizPfmclq7&#39;</span><span class="p">,</span>
  <span class="s1">&#39;retweet&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;#News by #almalki : Four aboard small plane die in crash on Utah highway https://t.co/sizPfmclq7&#39;</span><span class="p">,</span>
  <span class="s1">&#39;retweet&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;#News by #almalki : Four aboard small plane die in crash on Utah highway https://t.co/sizPfmclq7&#39;</span><span class="p">,</span>
  <span class="s1">&#39;retweet&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;#News by #almalki : Four aboard small plane die in crash on Utah highway https://t.co/sizPfmclq7&#39;</span><span class="p">,</span>
  <span class="s1">&#39;retweet&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;#News by #almalki : Four aboard small plane die in crash on Utah highway https://t.co/sizPfmclq7&#39;</span><span class="p">,</span>
  <span class="s1">&#39;retweet&#39;</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="iterate">
<h2>3. Iterate<a class="headerlink" href="#iterate" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="now-that-we-understand-what-we-re-matching-on">
<h3>Now that we understand what we&#8217;re matching on<a class="headerlink" href="#now-that-we-understand-what-we-re-matching-on" title="Permalink to this headline">Â¶</a></h3>
<ul class="simple">
<li><strong>Exclusions</strong>: The most important part of refining rules is often
excluding Tweets that are irrelevant. I mentinoed earlier that the
Search API provides a negation operator (the &#8220;<code class="docutils literal"><span class="pre">-</span></code>&#8221; operator), which
you should use for exclusions. Use the &#8220;<code class="docutils literal"><span class="pre">-</span></code>&#8221; operator to exclude
terms that show up in irrelevant spikes, to exclude certain kinds of
Tweets (say, exclude Retweets), or anything else that might mark a
Tweet as irrelevant (spammy hashtags, news articles that aren&#8217;t
interesting, etc).</li>
<li><strong>Advanced operators</strong>: examples with more advanced operators (I want
to cover URL matching, some entities maybe?)</li>
</ul>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># expand based on what you see (these are top terms that didn&#39;t seem relevant, look at the frequent terms we saw)</span>
<span class="n">_rule_b</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">(plane OR landed OR airport OR takeoff OR #wheelsup)</span>
<span class="s2">-is:retweet</span>
<span class="s2">-trump</span>
<span class="s2">-harry</span>
<span class="s2">-anncoulter</span>
<span class="s2">-&quot;ann coulter&quot;</span>
<span class="s2">-g20</span>
<span class="s2">-lawyer</span>
<span class="s2">-gimpo</span>
<span class="s2">-fuck</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">rule_b</span> <span class="o">=</span> <span class="n">gen_rule_payload</span><span class="p">(</span><span class="n">_rule_a</span><span class="p">,</span>
                          <span class="n">from_date</span><span class="o">=</span><span class="s2">&quot;2017-07-01&quot;</span><span class="p">,</span>
                          <span class="n">to_date</span><span class="o">=</span><span class="s2">&quot;2017-08-01&quot;</span><span class="p">,</span>
                          <span class="n">results_per_call</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>

<span class="n">results_list</span> <span class="o">=</span> <span class="n">collect_results</span><span class="p">(</span><span class="n">rule_b</span><span class="p">,</span> <span class="n">max_results</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">result_stream_args</span><span class="o">=</span><span class="n">search_args</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># look at frequent terms again</span>
<span class="n">get_frequent_terms</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">all_text</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results_list</span><span class="p">],</span> <span class="n">stop_words</span> <span class="o">=</span> <span class="s2">&quot;english&quot;</span><span class="p">,</span> <span class="n">ngram_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
    </tr>
    <tr>
      <th>token</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>flying home</th>
      <td>23</td>
    </tr>
    <tr>
      <th>g20 trump personally</th>
      <td>20</td>
    </tr>
    <tr>
      <th>home g20 trump</th>
      <td>20</td>
    </tr>
    <tr>
      <th>home g20</th>
      <td>20</td>
    </tr>
    <tr>
      <th>dictated son's</th>
      <td>20</td>
    </tr>
    <tr>
      <th>dictated son's initial</th>
      <td>20</td>
    </tr>
    <tr>
      <th>russian lawyer</th>
      <td>20</td>
    </tr>
    <tr>
      <th>russian lawyer meeting</th>
      <td>20</td>
    </tr>
    <tr>
      <th>personally dictated</th>
      <td>20</td>
    </tr>
    <tr>
      <th>personally dictated son's</th>
      <td>20</td>
    </tr>
    <tr>
      <th>g20 trump</th>
      <td>20</td>
    </tr>
    <tr>
      <th>son's initial</th>
      <td>20</td>
    </tr>
    <tr>
      <th>initial statement</th>
      <td>20</td>
    </tr>
    <tr>
      <th>statement russian lawyer</th>
      <td>20</td>
    </tr>
    <tr>
      <th>statement russian</th>
      <td>20</td>
    </tr>
    <tr>
      <th>son's initial statement</th>
      <td>20</td>
    </tr>
    <tr>
      <th>wapo flying home</th>
      <td>20</td>
    </tr>
    <tr>
      <th>lawyer meeting https://t.co/3optdabayw</th>
      <td>20</td>
    </tr>
    <tr>
      <th>initial statement russian</th>
      <td>20</td>
    </tr>
    <tr>
      <th>trump personally</th>
      <td>20</td>
    </tr>
  </tbody>
</table>
</div><div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># use the same &quot;_rule&quot; string</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Recall, our rule is: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_rule_b</span><span class="p">))</span>
<span class="n">count_rule_b</span> <span class="o">=</span> <span class="n">gen_rule_payload</span><span class="p">(</span><span class="n">_rule_b</span><span class="p">,</span>
                        <span class="n">from_date</span><span class="o">=</span><span class="s2">&quot;2017-07-01&quot;</span><span class="p">,</span>
                        <span class="n">to_date</span><span class="o">=</span><span class="s2">&quot;2017-08-01&quot;</span><span class="p">,</span>
                        <span class="n">count_bucket</span><span class="o">=</span><span class="s2">&quot;hour&quot;</span><span class="p">)</span>

<span class="c1"># the endpoint changes slightly to the &quot;counts&quot; endpoint</span>
<span class="n">count_args</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">search_args</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s2">&quot;endpoint&quot;</span><span class="p">:</span> <span class="n">change_to_count_endpoint</span><span class="p">(</span><span class="n">search_args</span><span class="p">[</span><span class="s2">&quot;endpoint&quot;</span><span class="p">])}}</span>

<span class="n">counts_list</span> <span class="o">=</span> <span class="n">collect_results</span><span class="p">(</span><span class="n">count_rule_b</span><span class="p">,</span> <span class="n">max_results</span><span class="o">=</span><span class="mi">24</span><span class="o">*</span><span class="mi">31</span><span class="p">,</span> <span class="n">result_stream_args</span><span class="o">=</span><span class="n">count_args</span><span class="p">)</span>

<span class="c1"># plot a timeseries of the Tweet counts</span>
<span class="n">tweet_counts</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">counts_list</span><span class="p">)</span>
                <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">time_bucket</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;timePeriod&quot;</span><span class="p">]))</span>
                <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;timePeriod&quot;</span><span class="p">,</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
                <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;time_bucket&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">sort_index</span><span class="p">())</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="p">(</span><span class="n">tweet_counts</span>
 <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
       <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Count of Tweets per hour&quot;</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="kc">False</span><span class="p">));</span>
<span class="p">(</span><span class="n">tweet_counts</span>
 <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">)</span>
 <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
 <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
       <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Count of Tweets per day&quot;</span><span class="p">,</span>
       <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">));</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Recall</span><span class="p">,</span> <span class="n">our</span> <span class="n">rule</span> <span class="ow">is</span><span class="p">:</span>
<span class="p">(</span><span class="n">plane</span> <span class="n">OR</span> <span class="n">landed</span> <span class="n">OR</span> <span class="n">airport</span> <span class="n">OR</span> <span class="n">takeoff</span> <span class="n">OR</span> <span class="c1">#wheelsup)</span>
<span class="o">-</span><span class="ow">is</span><span class="p">:</span><span class="n">retweet</span>
<span class="o">-</span><span class="n">trump</span>
<span class="o">-</span><span class="n">harry</span>
<span class="o">-</span><span class="n">anncoulter</span>
<span class="o">-</span><span class="s2">&quot;ann coulter&quot;</span>
<span class="o">-</span><span class="n">g20</span>
<span class="o">-</span><span class="n">lawyer</span>
<span class="o">-</span><span class="n">gimpo</span>
<span class="o">-</span><span class="n">fuck</span>
</pre></div>
</div>
<img alt="_images/collecting-and-filtering-tweets-draft_53_1.png" src="_images/collecting-and-filtering-tweets-draft_53_1.png" />
</div>
<div class="section" id="look-at-that-regular-timeseries">
<h3>Look at that regular timeseries!<a class="headerlink" href="#look-at-that-regular-timeseries" title="Permalink to this headline">Â¶</a></h3>
<p>Remember when I noted that the Tweet timeseries around flying is
unlikely to have big, irregular spikes? It seems like we got rid of most
of them, save one or two. Let&#8217;s look into those last spikes and exclude
those too.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># let&#39;s look at the highest volume day</span>
<span class="n">spike_rule_711</span> <span class="o">=</span> <span class="n">gen_rule_payload</span><span class="p">(</span><span class="n">_rule_b</span><span class="p">,</span> <span class="c1">#&lt;-remember, same rule</span>
                                  <span class="n">from_date</span><span class="o">=</span><span class="s2">&quot;2017-07-11&quot;</span><span class="p">,</span>
                                  <span class="n">to_date</span><span class="o">=</span><span class="s2">&quot;2017-07-12&quot;</span><span class="p">,</span>
                                  <span class="p">)</span>

<span class="c1"># force results to evaluate (this step actually makes the API calls)</span>
<span class="n">spike_results_list_711</span> <span class="o">=</span> <span class="n">collect_results</span><span class="p">(</span><span class="n">spike_rule_711</span><span class="p">,</span> <span class="n">max_results</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">result_stream_args</span><span class="o">=</span><span class="n">search_args</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">get_frequent_terms</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">all_text</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spike_results_list_711</span><span class="p">],</span> <span class="n">stop_words</span> <span class="o">=</span> <span class="s2">&quot;english&quot;</span><span class="p">,</span> <span class="n">ngram_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
</pre></div>
</div>
<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
    </tr>
    <tr>
      <th>token</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>plane</th>
      <td>244</td>
    </tr>
    <tr>
      <th>airport</th>
      <td>197</td>
    </tr>
    <tr>
      <th>crash</th>
      <td>64</td>
    </tr>
    <tr>
      <th>landed</th>
      <td>47</td>
    </tr>
    <tr>
      <th>mississippi</th>
      <td>42</td>
    </tr>
    <tr>
      <th>international</th>
      <td>38</td>
    </tr>
    <tr>
      <th>marine</th>
      <td>38</td>
    </tr>
    <tr>
      <th>i'm</th>
      <td>36</td>
    </tr>
    <tr>
      <th>killed</th>
      <td>35</td>
    </tr>
    <tr>
      <th>vermont</th>
      <td>29</td>
    </tr>
    <tr>
      <th>flight</th>
      <td>23</td>
    </tr>
    <tr>
      <th>just</th>
      <td>22</td>
    </tr>
    <tr>
      <th>taxiway</th>
      <td>22</td>
    </tr>
    <tr>
      <th>san</th>
      <td>21</td>
    </tr>
    <tr>
      <th>air</th>
      <td>18</td>
    </tr>
  </tbody>
</table>
</div></div>
<div class="section" id="frequent-terms-vs-frequent-n-grams">
<h3>Frequent terms vs frequent &#8220;n-grams&#8221;<a class="headerlink" href="#frequent-terms-vs-frequent-n-grams" title="Permalink to this headline">Â¶</a></h3>
<p>We&#8217;ve talked about using frequent terms to identify what a corpus of
Tweets is about, but I want to mention frequent &#8220;n-grams&#8221; as a slightly
more sophisticated alternative.</p>
<p><strong>n-gram</strong>: a sequence of <em>n</em> tokens from a document</p>
<p>Using frequent n-grams, you might be able to identify when words show
together, in the same sequence surprisingly often&#8211;potentially
indicating spam, promotional material, memes, lyrics, or reposted
content. Pay attention to words that appear together, and you can
exclude an n-gram by excluding an &#8220;exact phrase&#8221; from your Search query.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># let&#39;s look at 2- and 3- grams</span>
<span class="n">get_frequent_terms</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">all_text</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spike_results_list_711</span><span class="p">],</span> <span class="n">stop_words</span> <span class="o">=</span> <span class="s2">&quot;english&quot;</span><span class="p">,</span> <span class="n">ngram_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
    </tr>
    <tr>
      <th>token</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>plane crash</th>
      <td>58</td>
    </tr>
    <tr>
      <th>international airport</th>
      <td>37</td>
    </tr>
    <tr>
      <th>mississippi plane</th>
      <td>30</td>
    </tr>
    <tr>
      <th>mississippi plane crash</th>
      <td>30</td>
    </tr>
    <tr>
      <th>killed mississippi plane</th>
      <td>29</td>
    </tr>
    <tr>
      <th>marine vermont</th>
      <td>29</td>
    </tr>
    <tr>
      <th>marine vermont killed</th>
      <td>29</td>
    </tr>
    <tr>
      <th>vermont killed mississippi</th>
      <td>29</td>
    </tr>
    <tr>
      <th>vermont killed</th>
      <td>29</td>
    </tr>
    <tr>
      <th>killed mississippi</th>
      <td>29</td>
    </tr>
    <tr>
      <th>san francisco</th>
      <td>17</td>
    </tr>
    <tr>
      <th>military plane</th>
      <td>13</td>
    </tr>
    <tr>
      <th>nearly lands</th>
      <td>11</td>
    </tr>
    <tr>
      <th>plane ticket</th>
      <td>11</td>
    </tr>
    <tr>
      <th>greatest aviation</th>
      <td>10</td>
    </tr>
    <tr>
      <th>plane landed</th>
      <td>10</td>
    </tr>
    <tr>
      <th>greatest aviation disaster</th>
      <td>10</td>
    </tr>
    <tr>
      <th>air canada</th>
      <td>10</td>
    </tr>
    <tr>
      <th>aviation disaster</th>
      <td>10</td>
    </tr>
    <tr>
      <th>landed san</th>
      <td>9</td>
    </tr>
  </tbody>
</table>
</div><p>In my data, I can see that &#8220;mississippi plane crash&#8221;, &#8220;killed
mississippi plane &#8221;, &#8220;vermont killed mississippi&#8221; all show up
frequently, and they all show up <em>the same number of times</em>. Let me find
one of those Tweets to look at:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">all_text</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spike_results_list_711</span> <span class="k">if</span> <span class="s2">&quot;vermont&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">all_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
<pre class="literal-block">
['Marine from Vermont killed in Mississippi planexa0crash <a class="reference external" href="https://t.co/RGnRfCI0lg">https://t.co/RGnRfCI0lg</a>',
 'KMBC  &#64;kmbcn Marine from Vermont killed in Mississippi plane crash <a class="reference external" href="https://t.co/DirY01X2Pd">https://t.co/DirY01X2Pd</a> <a class="reference external" href="https://t.co/QTaRr1JkNQ">https://t.co/QTaRr1JkNQ</a>',
 'Pittsburgh News Marine from Vermont killed in Mississippi plane crash <a class="reference external" href="https://t.co/dk71SLzkm5">https://t.co/dk71SLzkm5</a> <a class="reference external" href="https://t.co/JfgXcdO1yR">https://t.co/JfgXcdO1yR</a>',
 'Marine from Vermont killed in Mississippi plane crash <a class="reference external" href="https://t.co/HvjlG7vp6W">https://t.co/HvjlG7vp6W</a> <a class="reference external" href="https://t.co/Ij4MCBBFQn">https://t.co/Ij4MCBBFQn</a>',
 'Marine from Vermont killed in Mississippi plane crash <a class="reference external" href="https://t.co/7hSTiZxMmX">https://t.co/7hSTiZxMmX</a> <a class="reference external" href="https://t.co/irB0fdy6Vs">https://t.co/irB0fdy6Vs</a>']
</pre>
<p>Doesn&#8217;t have much to do with the exerience of flying in a plane. Let&#8217;s
exclude it. In this case, I might exclude these Tweets pretty precisely
by excluding &#8220;Marine&#8221; (it&#8217;s good to pick spefic, unambiguous terms for
exclusions, so that you don&#8217;t do anything too broad), but for my example
I&#8217;m going to exclude &#8220;plane crash&#8221;&#8211;it&#8217;s precise enough, will exclude
other similar news-type content, and I can demonstrate exact phrase
matching.</p>
<p>Add this to my rule: <code class="docutils literal"><span class="pre">-&quot;plane</span> <span class="pre">crash&quot;</span></code></p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># expand based on what you see</span>
<span class="n">_rule_c</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">(plane OR landed OR airport OR takeoff OR #wheelsup)</span>
<span class="s2">-is:retweet</span>
<span class="s2">-trump</span>
<span class="s2">-harry</span>
<span class="s2">-anncoulter</span>
<span class="s2">-&quot;ann coulter&quot;</span>
<span class="s2">-g20</span>
<span class="s2">-lawyer</span>
<span class="s2">-gimpo</span>
<span class="s2">-fuck</span>
<span class="s2">-&quot;plane crash&quot;</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">spike_rule_704</span> <span class="o">=</span> <span class="n">gen_rule_payload</span><span class="p">(</span><span class="n">_rule_c</span><span class="p">,</span> <span class="c1">#&lt;-remember, same rule</span>
                                  <span class="n">from_date</span><span class="o">=</span><span class="s2">&quot;2017-07-04&quot;</span><span class="p">,</span>
                                  <span class="n">to_date</span><span class="o">=</span><span class="s2">&quot;2017-07-05&quot;</span><span class="p">,</span>
                                  <span class="p">)</span>

<span class="n">spike_results_list_704</span> <span class="o">=</span> <span class="n">collect_results</span><span class="p">(</span><span class="n">spike_rule_704</span><span class="p">,</span> <span class="n">max_results</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">result_stream_args</span><span class="o">=</span><span class="n">search_args</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">get_frequent_terms</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">all_text</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spike_results_list_704</span><span class="p">],</span> <span class="n">stop_words</span> <span class="o">=</span> <span class="s2">&quot;english&quot;</span><span class="p">,</span> <span class="n">ngram_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
    </tr>
    <tr>
      <th>token</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>citizens east hampton</th>
      <td>39</td>
    </tr>
    <tr>
      <th>east hampton airport</th>
      <td>39</td>
    </tr>
    <tr>
      <th>citizens east</th>
      <td>39</td>
    </tr>
    <tr>
      <th>hampton airport</th>
      <td>39</td>
    </tr>
    <tr>
      <th>east hampton</th>
      <td>39</td>
    </tr>
    <tr>
      <th>international airport</th>
      <td>31</td>
    </tr>
    <tr>
      <th>hampton airport james</th>
      <td>29</td>
    </tr>
    <tr>
      <th>airport james</th>
      <td>29</td>
    </tr>
    <tr>
      <th>airport james barron</th>
      <td>29</td>
    </tr>
    <tr>
      <th>james barron</th>
      <td>29</td>
    </tr>
    <tr>
      <th>barron nyt</th>
      <td>26</td>
    </tr>
    <tr>
      <th>james barron nyt</th>
      <td>26</td>
    </tr>
    <tr>
      <th>new york</th>
      <td>17</td>
    </tr>
    <tr>
      <th>#android #gameinsight</th>
      <td>16</td>
    </tr>
    <tr>
      <th>airport city</th>
      <td>15</td>
    </tr>
    <tr>
      <th>new york times</th>
      <td>14</td>
    </tr>
    <tr>
      <th>york times</th>
      <td>14</td>
    </tr>
    <tr>
      <th>barron nyt new</th>
      <td>13</td>
    </tr>
    <tr>
      <th>nyt new</th>
      <td>13</td>
    </tr>
    <tr>
      <th>nyt new york</th>
      <td>13</td>
    </tr>
  </tbody>
</table>
</div><div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># no idea what that&#39;s about, honestly. let&#39;s find a Tweet. try searching on the hashtag:</span>
<span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">all_text</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spike_results_list_704</span> <span class="k">if</span> <span class="s2">&quot;gameinsight&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">hashtags</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="s1">&#39;Â¡He completado la misiÃ³n DÃ­a Desafortunado en el juego Airport-City! https://t.co/Ya2oVyXXHo #android #gameinsight&#39;</span><span class="p">,</span>
 <span class="s1">&#39;Â¡He alcanzado el nivel 8 en el juego Airport-City! https://t.co/Ya2oVyXXHo #android #gameinsight&#39;</span><span class="p">,</span>
 <span class="s1">&#39;New plane in my Airport City: Turboprop! https://t.co/Ky4J5dMyBT #iOS #gameinsight&#39;</span><span class="p">,</span>
 <span class="s2">&quot;I&#39;ve completed Party Like You Mean It quest in Airport City! https://t.co/QaJ1PIehi7 #android #gameinsight&quot;</span><span class="p">,</span>
 <span class="s2">&quot;I&#39;ve completed A Chinese Torture quest in Airport City! https://t.co/QaJ1PIehi7 #android #gameinsight&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>Well, that looks like spam. Let&#8217;s exclude a hashtag this time: it&#8217;s
specific, seems to appear in this content, and easy to exclude. Use the
hashtag and negation operator in Search like this:</p>
<p>Add <code class="docutils literal"><span class="pre">-#gameinsight</span></code></p>
<p>Also, I&#8217;m not sure that &#8220;gameinsight&#8221; is all of this spike. Try
searching for &#8220;hampton&#8221; too:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">all_text</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spike_results_list_704</span> <span class="k">if</span> <span class="s2">&quot;hampton&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">all_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="s1">&#39;The Citizens of East Hampton v. Its Airport https://t.co/xDRiyor0Ej&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&quot;The Citizens of East Hampton v. Its Airport&quot; https://t.co/Fm6NOXqRen&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&quot;The Citizens of East Hampton v. Its Airport&quot; by JAMES BARRON via NYT https://t.co/LAMg6kHkZN https://t.co/pHhMKTw8Kx&#39;</span><span class="p">,</span>
 <span class="s1">&#39;#3Novices : The Citizens of East Hampton v. Its Airport The Supreme Courtâ€™s refusal last week to review local restrictions on flights is thâ€¦&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&quot;The Citizens of East Hampton v. Its Airport&quot; by JAMES BARRON via NYT https://t.co/eaW8rdnj4M&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>Now, I could add: <code class="docutils literal"><span class="pre">-&quot;citizens</span> <span class="pre">of</span> <span class="pre">east</span> <span class="pre">hampton&quot;</span></code> and exclude this one
news story, but I think I&#8217;ve identified a larger pattern.</p>
</div>
<div class="section" id="url-matching">
<h3>URL matching<a class="headerlink" href="#url-matching" title="Permalink to this headline">Â¶</a></h3>
<p>News stories about planes, crashes, etc are showing up a lot, and I&#8217;m
not sure I want to see any of them in my final dataset (again, this is
absolutely a choice, and it will eliminate a lot of data, for better or
for worse). I&#8217;m going to choose to exclude all Tweets with certain big
news URLs included in them. I&#8217;m not going to get this perfect here, but
I will show you how to use the URL matching rule, and give you more
ideas about how to filter Tweets.</p>
<p>The <code class="docutils literal"><span class="pre">url:&lt;token&gt;</span></code> operator performs a tokenized match on words in the
unrolled URL that was posted in the Tweet. I&#8217;ll eliminate Tweets with:
&#8220;nytimes&#8221;,&#8221;bbc&#8221;,&#8221;washingtonpost&#8221;, &#8220;cbsnews&#8221;, &#8220;reuters&#8221;, &#8220;apnews&#8221;, and
&#8220;news&#8221; in the URL.</p>
<p>Add:
<code class="docutils literal"><span class="pre">-url:nytimes</span> <span class="pre">-url:bbc</span> <span class="pre">-url:washingtonpost</span> <span class="pre">-url:cbsnews</span> <span class="pre">-url:reuters</span> <span class="pre">-url:apnews</span> <span class="pre">-url:news</span></code></p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># expand based on what you see</span>
<span class="n">_rule_d</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">(plane OR landed OR airport OR takeoff OR #wheelsup)</span>
<span class="s2">-is:retweet</span>
<span class="s2">-trump</span>
<span class="s2">-harry</span>
<span class="s2">-anncoulter</span>
<span class="s2">-&quot;ann coulter&quot;</span>
<span class="s2">-g20</span>
<span class="s2">-lawyer</span>
<span class="s2">-gimpo</span>
<span class="s2">-fuck</span>
<span class="s2">-&quot;plane crash&quot;</span>
<span class="s2">-&quot;citizens of east hampton&quot;</span>
<span class="s2">-url:nytimes -url:bbc -url:washingtonpost -url:cbsnews -url:reuters -url:apnews -url:news</span>
<span class="s2">&quot;&quot;&quot;</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># finally, let&#39;s look at that high volume hour on July 3rd</span>
<span class="n">tweet_counts</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span> <span class="o">=</span> <span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="n">ascending</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
    </tr>
    <tr>
      <th>time_bucket</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-07-03 18:00:00</th>
      <td>5098</td>
    </tr>
    <tr>
      <th>2017-07-03 19:00:00</th>
      <td>4502</td>
    </tr>
  </tbody>
</table>
</div><div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">spike_rule_703</span> <span class="o">=</span> <span class="n">gen_rule_payload</span><span class="p">(</span><span class="n">_rule_d</span><span class="p">,</span> <span class="c1">#&lt;-remember, same rule</span>
                                  <span class="n">from_date</span><span class="o">=</span><span class="s2">&quot;2017-07-03T18:00&quot;</span><span class="p">,</span>
                                  <span class="n">to_date</span><span class="o">=</span><span class="s2">&quot;2017-07-03T19:01&quot;</span><span class="p">,</span>
                                  <span class="p">)</span>

<span class="c1"># force results to evaluate (this step actually makes the API calls)</span>
<span class="n">spike_results_list_703</span> <span class="o">=</span> <span class="n">collect_results</span><span class="p">(</span><span class="n">spike_rule_703</span><span class="p">,</span> <span class="n">max_results</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">result_stream_args</span><span class="o">=</span><span class="n">search_args</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">get_frequent_terms</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">all_text</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spike_results_list_703</span><span class="p">],</span> <span class="n">stop_words</span> <span class="o">=</span> <span class="s2">&quot;english&quot;</span><span class="p">,</span> <span class="n">ngram_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
    </tr>
    <tr>
      <th>token</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>boston airport</th>
      <td>131</td>
    </tr>
    <tr>
      <th>near boston</th>
      <td>82</td>
    </tr>
    <tr>
      <th>near boston airport</th>
      <td>77</td>
    </tr>
    <tr>
      <th>logan airport</th>
      <td>68</td>
    </tr>
    <tr>
      <th>pedestrians near</th>
      <td>57</td>
    </tr>
    <tr>
      <th>vehicle near</th>
      <td>52</td>
    </tr>
    <tr>
      <th>vehicle near boston</th>
      <td>52</td>
    </tr>
    <tr>
      <th>pedestrians struck</th>
      <td>50</td>
    </tr>
    <tr>
      <th>pedestrians struck vehicle</th>
      <td>50</td>
    </tr>
    <tr>
      <th>struck vehicle near</th>
      <td>50</td>
    </tr>
    <tr>
      <th>airport injured</th>
      <td>50</td>
    </tr>
    <tr>
      <th>struck vehicle</th>
      <td>50</td>
    </tr>
    <tr>
      <th>boston airport injured</th>
      <td>44</td>
    </tr>
    <tr>
      <th>international airport</th>
      <td>35</td>
    </tr>
    <tr>
      <th>boston's logan</th>
      <td>35</td>
    </tr>
    <tr>
      <th>boston's logan airport</th>
      <td>34</td>
    </tr>
    <tr>
      <th>people injured</th>
      <td>33</td>
    </tr>
    <tr>
      <th>multiple people</th>
      <td>30</td>
    </tr>
    <tr>
      <th>car strikes</th>
      <td>30</td>
    </tr>
    <tr>
      <th>near logan</th>
      <td>30</td>
    </tr>
  </tbody>
</table>
</div><div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># read some Tweets</span>
<span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">all_text</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spike_results_list_703</span> <span class="k">if</span> <span class="s2">&quot;Boston&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">all_text</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
<pre class="literal-block">
['#gossip Car Strikes Crowd at East Boston Airport, Multiple People Injured <a class="reference external" href="https://t.co/lK1EIbm9OJ">https://t.co/lK1EIbm9OJ</a>',
 'Tru Town Films Car Strikes Crowd at East Boston Airport, Multiple People Injured <a class="reference external" href="https://t.co/eUy8dWqXuD">https://t.co/eUy8dWqXuD</a>',
 'Car Strikes Crowd at East Boston Airport, Multiple People Injured <a class="reference external" href="https://t.co/4YcPZ3QkZA">https://t.co/4YcPZ3QkZA</a>',
 'Car Strikes Crowd at East Boston Airport, Multiple Peoplexa0Injured <a class="reference external" href="https://t.co/yyijNbPa4p">https://t.co/yyijNbPa4p</a>',
 'Pedestrians struck by vehicle near Boston airport, several injuries reported <a class="reference external" href="https://t.co/yOnQ9bGWBk">https://t.co/yOnQ9bGWBk</a> #p2 #ctl <a class="reference external" href="https://t.co/ugVOtnwzLsnn">https://t.co/ugVOtnwzLsnn</a>â€” â€¦',
 &quot;The Times Picayune - Vehicle hits pedestrians near Boston's Logan Airport: report <a class="reference external" href="https://t.co/BpDCYg2i5R">https://t.co/BpDCYg2i5R</a>&quot;,
 'Police: Boston airport crash injures 10 pedestrians <a class="reference external" href="https://t.co/YlGlcHFd8u">https://t.co/YlGlcHFd8u</a>',
 'Update: Taxi incident near Boston airport being treated as accident, not terrorism, law enforcement sources say <a class="reference external" href="https://t.co/kgvXLkd4Zk">https://t.co/kgvXLkd4Zk</a>',
 'Car Strikes Crowd at East Boston Airport, Multiple People Injured <a class="reference external" href="https://t.co/PfJ7xhgPLT">https://t.co/PfJ7xhgPLT</a>',
 'Taxi strikes pedestrians near Boston airport, policexa0say <a class="reference external" href="https://t.co/gKwp3D5sA9">https://t.co/gKwp3D5sA9</a>']
</pre>
<p>I don&#8217;t want to eliminate all mentions of &#8220;Boston Airport&#8221; (because many
of those mentions are likely relevant to my study). Instead, I&#8217;ll
eliminate a few common phrases like &#8220;pedestrians struck&#8221;, &#8220;pedestrians
injured&#8221;, &#8220;car strikes&#8221;, &#8220;taxi strikes&#8221;.</p>
<p>Add:
<code class="docutils literal"><span class="pre">-&quot;pedestrians</span> <span class="pre">struck&quot;</span> <span class="pre">-&quot;pedstrians</span> <span class="pre">injured&quot;</span> <span class="pre">-&quot;car</span> <span class="pre">strikes&quot;</span> <span class="pre">-&quot;taxi</span> <span class="pre">strikes&quot;</span> <span class="pre">-&quot;car</span> <span class="pre">hits&quot;</span></code></p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># expand based on what you see</span>
<span class="n">_rule_e</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">(plane OR landed OR airport OR takeoff OR #wheelsup)</span>
<span class="s2">-is:retweet</span>
<span class="s2">-trump</span>
<span class="s2">-harry</span>
<span class="s2">-anncoulter</span>
<span class="s2">-&quot;ann coulter&quot;</span>
<span class="s2">-g20</span>
<span class="s2">-lawyer</span>
<span class="s2">-gimpo</span>
<span class="s2">-fuck</span>
<span class="s2">-&quot;plane crash&quot;</span>
<span class="s2">-#gameinsight</span>
<span class="s2">-&quot;citizens of east hampton&quot;</span>
<span class="s2">-url:nytimes -url:bbc -url:washingtonpost -url:cbsnews -url:reuters -url:apnews -url:news</span>
<span class="s2">-&quot;pedestrians struck&quot; -&quot;pedstrians injured&quot; -&quot;car strikes&quot; -&quot;taxi strikes&quot; -&quot;car hits&quot;</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">rule_e</span> <span class="o">=</span> <span class="n">gen_rule_payload</span><span class="p">(</span><span class="n">_rule_e</span><span class="p">,</span>
                        <span class="n">from_date</span><span class="o">=</span><span class="s2">&quot;2017-07-01&quot;</span><span class="p">,</span>
                        <span class="n">to_date</span><span class="o">=</span><span class="s2">&quot;2017-08-01&quot;</span><span class="p">,</span>
                        <span class="p">)</span>

<span class="n">results_list</span> <span class="o">=</span> <span class="n">collect_results</span><span class="p">(</span><span class="n">rule_e</span><span class="p">,</span> <span class="n">max_results</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">result_stream_args</span><span class="o">=</span><span class="n">search_args</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Recall, our new rule is: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_rule_e</span><span class="p">))</span>
<span class="n">count_rule_e</span> <span class="o">=</span> <span class="n">gen_rule_payload</span><span class="p">(</span><span class="n">_rule_e</span><span class="p">,</span>
                        <span class="n">from_date</span><span class="o">=</span><span class="s2">&quot;2017-07-01&quot;</span><span class="p">,</span>
                        <span class="n">to_date</span><span class="o">=</span><span class="s2">&quot;2017-08-01&quot;</span><span class="p">,</span>
                        <span class="n">count_bucket</span><span class="o">=</span><span class="s2">&quot;hour&quot;</span><span class="p">)</span>

<span class="c1"># the endpoint changes slightly to the &quot;counts&quot; endpoint</span>
<span class="n">count_args</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">search_args</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s2">&quot;endpoint&quot;</span><span class="p">:</span> <span class="n">change_to_count_endpoint</span><span class="p">(</span><span class="n">search_args</span><span class="p">[</span><span class="s2">&quot;endpoint&quot;</span><span class="p">])}}</span>

<span class="n">counts_list</span> <span class="o">=</span> <span class="n">collect_results</span><span class="p">(</span><span class="n">count_rule_e</span><span class="p">,</span> <span class="n">max_results</span><span class="o">=</span><span class="mi">24</span><span class="o">*</span><span class="mi">31</span><span class="p">,</span> <span class="n">result_stream_args</span><span class="o">=</span><span class="n">count_args</span><span class="p">)</span>

<span class="c1"># plot a timeseries of the Tweet counts</span>
<span class="n">tweet_counts</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">counts_list</span><span class="p">)</span>
     <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">time_bucket</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;timePeriod&quot;</span><span class="p">]))</span>
     <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;timePeriod&quot;</span><span class="p">,</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
     <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;time_bucket&quot;</span><span class="p">)</span>
     <span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">tweet_counts</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Count of Tweets per hour&quot;</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">tweet_counts</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Count of Tweets per day&quot;</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Recall</span><span class="p">,</span> <span class="n">our</span> <span class="n">new</span> <span class="n">rule</span> <span class="ow">is</span><span class="p">:</span>
<span class="p">(</span><span class="n">plane</span> <span class="n">OR</span> <span class="n">landed</span> <span class="n">OR</span> <span class="n">airport</span> <span class="n">OR</span> <span class="n">takeoff</span> <span class="n">OR</span> <span class="c1">#wheelsup)</span>
<span class="o">-</span><span class="ow">is</span><span class="p">:</span><span class="n">retweet</span>
<span class="o">-</span><span class="n">trump</span>
<span class="o">-</span><span class="n">harry</span>
<span class="o">-</span><span class="n">anncoulter</span>
<span class="o">-</span><span class="s2">&quot;ann coulter&quot;</span>
<span class="o">-</span><span class="n">g20</span>
<span class="o">-</span><span class="n">lawyer</span>
<span class="o">-</span><span class="n">gimpo</span>
<span class="o">-</span><span class="n">fuck</span>
<span class="o">-</span><span class="s2">&quot;plane crash&quot;</span>
<span class="o">-</span><span class="c1">#gameinsight</span>
<span class="o">-</span><span class="s2">&quot;citizens of east hampton&quot;</span>
<span class="o">-</span><span class="n">url</span><span class="p">:</span><span class="n">nytimes</span> <span class="o">-</span><span class="n">url</span><span class="p">:</span><span class="n">bbc</span> <span class="o">-</span><span class="n">url</span><span class="p">:</span><span class="n">washingtonpost</span> <span class="o">-</span><span class="n">url</span><span class="p">:</span><span class="n">cbsnews</span> <span class="o">-</span><span class="n">url</span><span class="p">:</span><span class="n">reuters</span> <span class="o">-</span><span class="n">url</span><span class="p">:</span><span class="n">apnews</span> <span class="o">-</span><span class="n">url</span><span class="p">:</span><span class="n">news</span>
<span class="o">-</span><span class="s2">&quot;pedestrians struck&quot;</span> <span class="o">-</span><span class="s2">&quot;pedstrians injured&quot;</span> <span class="o">-</span><span class="s2">&quot;car strikes&quot;</span> <span class="o">-</span><span class="s2">&quot;taxi strikes&quot;</span> <span class="o">-</span><span class="s2">&quot;car hits&quot;</span>
</pre></div>
</div>
<img alt="_images/collecting-and-filtering-tweets-draft_75_1.png" src="_images/collecting-and-filtering-tweets-draft_75_1.png" />
</div>
<div class="section" id="look-how-much-irrelevant-data-we-ve-eliminated">
<h3>Look how much irrelevant data we&#8217;ve eliminated<a class="headerlink" href="#look-how-much-irrelevant-data-we-ve-eliminated" title="Permalink to this headline">Â¶</a></h3>
<p>Let&#8217;s compare the volume of our first (un-refined) rule to our most
recent one.</p>
<p>Spoiler: We&#8217;ve eliminated a huge amount of unhelpful data!</p>
<p>Now you can begin to think about using this data in an analysis.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">tweet_counts_original</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Count of Tweets per day&quot;</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">tweet_counts</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Count of Tweets per day&quot;</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">_subplots</span><span class="o">.</span><span class="n">AxesSubplot</span> <span class="n">at</span> <span class="mh">0x11ff3b128</span><span class="o">&gt;</span>
</pre></div>
</div>
<img alt="_images/collecting-and-filtering-tweets-draft_77_1.png" src="_images/collecting-and-filtering-tweets-draft_77_1.png" />
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">get_frequent_terms</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">all_text</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results_list</span><span class="p">],</span> <span class="n">stop_words</span> <span class="o">=</span> <span class="s2">&quot;english&quot;</span><span class="p">,</span> <span class="n">ngram_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
    </tr>
    <tr>
      <th>token</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>airport</th>
      <td>249</td>
    </tr>
    <tr>
      <th>plane</th>
      <td>177</td>
    </tr>
    <tr>
      <th>landed</th>
      <td>63</td>
    </tr>
    <tr>
      <th>i'm</th>
      <td>35</td>
    </tr>
    <tr>
      <th>international</th>
      <td>34</td>
    </tr>
    <tr>
      <th>just</th>
      <td>34</td>
    </tr>
    <tr>
      <th>international airport</th>
      <td>32</td>
    </tr>
    <tr>
      <th>like</th>
      <td>23</td>
    </tr>
    <tr>
      <th>people</th>
      <td>21</td>
    </tr>
    <tr>
      <th>time</th>
      <td>18</td>
    </tr>
    <tr>
      <th>security</th>
      <td>17</td>
    </tr>
    <tr>
      <th>takeoff</th>
      <td>15</td>
    </tr>
    <tr>
      <th>flight</th>
      <td>15</td>
    </tr>
    <tr>
      <th>don't</th>
      <td>15</td>
    </tr>
    <tr>
      <th>got</th>
      <td>14</td>
    </tr>
    <tr>
      <th>today</th>
      <td>14</td>
    </tr>
    <tr>
      <th>passenger</th>
      <td>14</td>
    </tr>
    <tr>
      <th>hours</th>
      <td>13</td>
    </tr>
    <tr>
      <th>know</th>
      <td>12</td>
    </tr>
    <tr>
      <th>just landed</th>
      <td>12</td>
    </tr>
  </tbody>
</table>
</div></div>
<div class="section" id="pulling-our-dataset">
<h3>Pulling our dataset<a class="headerlink" href="#pulling-our-dataset" title="Permalink to this headline">Â¶</a></h3>
<p>It&#8217;s always possible to continue refining a dataset, and we should
definitely continue that work after pulling the Tweets. The key in early
data-cleaning steps is to eliminate a large bulk of irrelevant Tweets
that you don&#8217;t want to store or pay for (we did that).</p>
<p>Now (<strong>warning!</strong> this will use quite a few API calls and you might want
to think twice before actually running it, I&#8217;ve changed the cell type so
you can&#8217;t run it on accident) let&#8217;s pull data with our final rule.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># the twittersearch package provides a conveinence function to show you how many API calls you&#39;ve already used</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;You have used </span><span class="si">{}</span><span class="s2"> API calls in this session&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ResultStream</span><span class="o">.</span><span class="n">session_request_counter</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">You</span> <span class="n">have</span> <span class="n">used</span> <span class="mi">11</span> <span class="n">API</span> <span class="n">calls</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">session</span>
</pre></div>
</div>
</div>
<div class="section" id="store-the-data-you-pull">
<h3>Store the data you pull!<a class="headerlink" href="#store-the-data-you-pull" title="Permalink to this headline">Â¶</a></h3>
<p>You don&#8217;t want to pull this much data without saving it for later. I&#8217;m
going to use the <code class="docutils literal"><span class="pre">ResultStream</span></code> object to make API calls, stream data
in an iterator, hold relevant data information in memory in my Python
session, and (importantly!) stream raw Tweets to a file for later use.</p>
<p>Even if you don&#8217;t want to run these exact API calls, pay attention to
how I do this for your own work.</p>
</div>
<div class="section" id="finalize-your-rule">
<h3>Finalize your rule<a class="headerlink" href="#finalize-your-rule" title="Permalink to this headline">Â¶</a></h3>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># this is our final rule</span>
<span class="nb">print</span><span class="p">(</span><span class="n">rule_e</span><span class="p">)</span>
</pre></div>
</div>
<pre class="literal-block">
{&quot;query&quot;:&quot;(plane OR landed OR airport OR takeoff OR #wheelsup) -is:retweet -trump -harry -anncoulter -&quot;ann coulter&quot; -g20 -lawyer -gimpo -fuck -&quot;plane crash&quot; -#gameinsight -&quot;citizens of east hampton&quot; -url:nytimes -url:bbc -url:washingtonpost -url:cbsnews -url:reuters -url:apnews -url:news -&quot;pedestrians struck&quot; -&quot;pedstrians injured&quot; -&quot;car strikes&quot; -&quot;taxi strikes&quot; -&quot;car hits&quot;&quot;,&quot;maxResults&quot;:500,&quot;toDate&quot;:&quot;201708010000&quot;,&quot;fromDate&quot;:&quot;201707010000&quot;}
</pre>
</div>
<div class="section" id="no-surprises">
<h3>No surprises<a class="headerlink" href="#no-surprises" title="Permalink to this headline">Â¶</a></h3>
<p>You should always have a guess at how many Tweets you&#8217;re going to pull
<em>before</em> you pull them. Use the Counts API (if possible), or extrapolate
based on a smaller time period of data.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># I can sum up the counts endpoint results to guess how may Tweets I&#39;ll get</span>
<span class="c1"># (or, if you don&#39;t have access to the counts endpoints, try extrapolating from a single day)</span>
<span class="n">tweet_counts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">count</span>    <span class="mi">1580076</span>
<span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</pre></div>
</div>
</div>
<div class="section" id="narrowing-your-dataset-further">
<h3>Narrowing your dataset further<a class="headerlink" href="#narrowing-your-dataset-further" title="Permalink to this headline">Â¶</a></h3>
<p>You might refine your rule and find that there are still millions of
Tweets about a topic on Twitter (this happens, there are lots of
Tweets).</p>
<p>If your rule is still going to pull an unrealistic number of Tweets,
maybe maybe narrow the scope of your investigation. You can: - <strong>Narrow
the time period</strong>: do you really need a month of data? or maybe you
could sample just a few days? - <strong>Select more specific Tweets</strong>: maybe
it would be helpful to your analysis to have only Tweets that are geo
tagged (this reduces data volume significantly)? Or only pull Tweets
from users with profile locations? Putting stringent requirements on
data can help speed up your analysis and make your data volume smaller.
- <strong>Sampling</strong>: Search API doesn&#8217;t support random sampling the way that
the Historical APIs do. You&#8217;ll have to come up with balanced ways of
selecting for less data, or you can sample based on geography, time,
Tweet language&#8211;anything to narrow your scope.</p>
<p>I&#8217;m going to show one example of this by <em>only</em> pulling Tweets from
users with a profile location (you can read up more on what a &#8220;profile
location&#8221; means in our documentation) in the state of Colorado (this is
for illustrative purposes, depending on your use case, I&#8217;d probably
recommend narrowing the time scope first).</p>
<p>Add: <code class="docutils literal"><span class="pre">profile_country:US</span> <span class="pre">profile_region:Colorado</span></code> to my Twitter Search
rule.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">final_rule</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">(plane OR landed OR airport OR takeoff OR #wheelsup)</span>
<span class="s2">-is:retweet</span>
<span class="s2">-trump</span>
<span class="s2">-harry</span>
<span class="s2">-anncoulter</span>
<span class="s2">-&quot;ann coulter&quot;</span>
<span class="s2">-g20</span>
<span class="s2">-lawyer</span>
<span class="s2">-gimpo</span>
<span class="s2">-fuck</span>
<span class="s2">-&quot;plane crash&quot;</span>
<span class="s2">-#gameinsight</span>
<span class="s2">-&quot;citizens of east hampton&quot;</span>
<span class="s2">-url:nytimes -url:bbc -url:washingtonpost -url:cbsnews -url:reuters -url:apnews -url:news</span>
<span class="s2">-&quot;pedestrians struck&quot; -&quot;pedstrians injured&quot; -&quot;car strikes&quot; -&quot;taxi strikes&quot; -&quot;car hits&quot;</span>
<span class="s2">profile_country:US profile_region:&quot;Colorado&quot;</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">count_rule</span> <span class="o">=</span> <span class="n">gen_rule_payload</span><span class="p">(</span><span class="n">final_rule</span><span class="p">,</span>
                        <span class="n">from_date</span><span class="o">=</span><span class="s2">&quot;2017-07-01&quot;</span><span class="p">,</span>
                        <span class="n">to_date</span><span class="o">=</span><span class="s2">&quot;2017-08-01&quot;</span><span class="p">,</span>
                        <span class="n">count_bucket</span><span class="o">=</span><span class="s2">&quot;hour&quot;</span><span class="p">)</span>

<span class="c1"># the endpoint changes slightly to the &quot;counts&quot; endpoint</span>
<span class="n">count_args</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">search_args</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s2">&quot;endpoint&quot;</span><span class="p">:</span> <span class="n">change_to_count_endpoint</span><span class="p">(</span><span class="n">search_args</span><span class="p">[</span><span class="s2">&quot;endpoint&quot;</span><span class="p">])}}</span>

<span class="n">counts_list</span> <span class="o">=</span> <span class="n">collect_results</span><span class="p">(</span><span class="n">count_rule</span><span class="p">,</span> <span class="n">max_results</span><span class="o">=</span><span class="mi">24</span><span class="o">*</span><span class="mi">31</span><span class="p">,</span> <span class="n">result_stream_args</span><span class="o">=</span><span class="n">count_args</span><span class="p">)</span>

<span class="c1"># plot a timeseries of the Tweet counts</span>
<span class="n">tweet_counts</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">counts_list</span><span class="p">)</span>
     <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">time_bucket</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;timePeriod&quot;</span><span class="p">]))</span>
     <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;timePeriod&quot;</span><span class="p">,</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
     <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;time_bucket&quot;</span><span class="p">)</span>
     <span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">tweet_counts</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Count of Tweets per hour&quot;</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">tweet_counts</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Count of Tweets per day&quot;</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/collecting-and-filtering-tweets-draft_87_0.png" src="_images/collecting-and-filtering-tweets-draft_87_0.png" />
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">tweet_counts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">count</span>    <span class="mi">7233</span>
<span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</pre></div>
</div>
</div>
<div class="section" id="save-tweets-to-a-file-and-stream-them-into-memory">
<h3>Save Tweets to a file, and stream them into memory<a class="headerlink" href="#save-tweets-to-a-file-and-stream-them-into-memory" title="Permalink to this headline">Â¶</a></h3>
<p>Seems like a reasonable number of Tweets. Let&#8217;s go get them.</p>
<p>This time, I&#8217;m going to use the ResultStream object and stream the full
Tweet payloads to a file while simultaneously creating a Pandas
DataFrame in memory of the limited Tweet fields that I care about.</p>
<p>If you actually want to run the cell below, you&#8217;ll have to set the cell
type to &#8220;code.&#8221;</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">final_rule_payload</span> <span class="o">=</span> <span class="n">gen_rule_payload</span><span class="p">(</span><span class="n">final_rule</span><span class="p">,</span>
                                      <span class="n">from_date</span><span class="o">=</span><span class="s2">&quot;2017-07-01&quot;</span><span class="p">,</span>
                                      <span class="n">to_date</span><span class="o">=</span><span class="s2">&quot;2017-08-01&quot;</span><span class="p">)</span>

<span class="n">stream</span> <span class="o">=</span> <span class="n">ResultStream</span><span class="p">(</span><span class="o">**</span><span class="n">search_args</span><span class="p">,</span>
                       <span class="n">rule_payload</span><span class="o">=</span><span class="n">final_rule_payload</span><span class="p">,</span>
                       <span class="n">max_results</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="c1"># should collect all of the results</span>

<span class="c1"># write_ndjson is a utility function that writes the results to a file and passes them through the iterator</span>
<span class="kn">from</span> <span class="nn">twittersearch.utils</span> <span class="k">import</span> <span class="n">write_ndjson</span>

<span class="n">limited_fields</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">write_ndjson</span><span class="p">(</span><span class="s2">&quot;air_travel_data.json&quot;</span><span class="p">,</span> <span class="n">stream</span><span class="o">.</span><span class="n">stream</span><span class="p">()):</span>
    <span class="n">limited_fields</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">created_at_datetime</span><span class="p">,</span>
                           <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">all_text</span><span class="p">,</span>
                           <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">screen_name</span><span class="p">,</span>
                           <span class="s2">&quot;bio&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">bio</span><span class="p">,</span>
                           <span class="s2">&quot;at_mentions&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">u</span><span class="p">[</span><span class="s2">&quot;screen_name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">user_mentions</span><span class="p">],</span>
                           <span class="s2">&quot;hashtags&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">hashtags</span><span class="p">,</span>
                           <span class="s2">&quot;urls&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">most_unrolled_urls</span><span class="p">,</span>
                           <span class="s2">&quot;geo&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">geo_coordinates</span><span class="p">,</span>
                           <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">tweet_type</span><span class="p">,</span>
                           <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
<span class="c1"># create a dataframe</span>
<span class="n">final_dataset_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">limited_fields</span><span class="p">)</span>
<span class="n">final_dataset_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2017, twitterdev.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.6.<br/>
    </p>
  </div>
</footer>
  </body>
</html>